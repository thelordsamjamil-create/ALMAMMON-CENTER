<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام تحليل بيانات المندوبين - مركز المامون الطبي التشخيصي</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ====== متغيرات الألوان الجديدة - تنسيق احترافي ====== */
        :root {
            --primary-color: #2C3E50;
            --secondary-color: #3498DB;
            --accent-color: #E74C3C;
            --success-color: #27AE60;
            --warning-color: #F39C12;
            --info-color: #1ABC9C;
            --light-color: #F8F9FA;
            --dark-color: #2C3E50;
            --gray-light: #ECF0F1;
            --gray-medium: #BDC3C7;
            --gray-dark: #7F8C8D;
            
            --card-bg: #FFFFFF;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --card-border: #E8E8E8;
            
            --gradient-primary: linear-gradient(135deg, var(--primary-color), #34495E);
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color), #2980B9);
            --gradient-accent: linear-gradient(135deg, var(--accent-color), #C0392B);
            --gradient-success: linear-gradient(135deg, var(--success-color), #229954);
            --gradient-info: linear-gradient(135deg, var(--info-color), #16A085);
            
            --font-size-base: 1.1rem;
            --font-weight-base: 700;
            --border-radius: 12px;
            --transition-speed: 0.3s;
        }
        
        /* ====== تنسيقات عامة ====== */
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
            color: var(--dark-color);
            line-height: 1.7;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-base);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 800 !important;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        /* ====== شريط التنقل ====== */
        .navbar {
            background: var(--gradient-primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 0.8rem 0;
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.4rem;
            color: white !important;
            padding: 0.5rem 0;
        }
        
        .navbar-brand i {
            font-size: 1.6rem;
            vertical-align: middle;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 700;
            padding: 0.5rem 1.2rem;
            border-radius: 6px;
            transition: all var(--transition-speed);
            margin: 0 0.2rem;
        }
        
        .navbar-nav .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white !important;
            transform: translateY(-2px);
        }
        
        /* ====== الشريط الجانبي ====== */
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, #1C2833 100%);
            color: white;
            min-height: calc(100vh - 72px);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,255,255,0.05) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.85) !important;
            padding: 14px 20px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all var(--transition-speed);
            font-weight: 700;
            border-right: 4px solid transparent;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white !important;
            border-right: 4px solid var(--accent-color);
            transform: translateX(-5px);
        }
        
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white !important;
            border-right: 4px solid var(--accent-color);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
        }
        
        .sidebar .nav-link i {
            font-size: 1.2rem;
            margin-left: 10px;
            width: 24px;
            text-align: center;
        }
        
        /* ====== البطاقات ====== */
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: all var(--transition-speed);
            margin-bottom: 25px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            font-weight: 800;
            font-size: 1.2rem;
            padding: 18px 25px;
            border-bottom: none;
        }
        
        .card-header i {
            font-size: 1.3rem;
            margin-left: 10px;
        }
        
        .card-body {
            padding: 25px;
        }
        
        /* ====== بطاقات الإحصائيات ====== */
        .stat-card {
            text-align: center;
            padding: 25px 20px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--card-border);
            transition: all var(--transition-speed);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-secondary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
        }
        
        .stat-card i {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
            background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-card .number {
            font-size: 2.4rem;
            font-weight: 900;
            color: var(--primary-color);
            line-height: 1;
            margin: 10px 0;
        }
        
        .stat-card .label {
            font-size: 1.1rem;
            color: var(--gray-dark);
            font-weight: 700;
        }
        
        /* ====== الأزرار ====== */
        .btn {
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 700;
            transition: all var(--transition-speed);
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: width 0.4s;
        }
        
        .btn:hover::before {
            width: 100%;
            right: auto;
            left: 0;
        }
        
        .btn-primary {
            background: var(--gradient-secondary);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2980B9, var(--secondary-color));
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: var(--gradient-success);
            border: none;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #229954, var(--success-color));
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(39, 174, 96, 0.3);
        }
        
        .btn-outline-primary {
            color: var(--secondary-color);
            border: 2px solid var(--secondary-color);
            background: transparent;
        }
        
        .btn-outline-primary:hover {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(52, 152, 219, 0.3);
        }
        
        .btn-outline-success {
            color: var(--success-color);
            border: 2px solid var(--success-color);
            background: transparent;
        }
        
        .btn-outline-success:hover {
            background: var(--success-color);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(39, 174, 96, 0.3);
        }
        
        /* ====== الجداول ====== */
        .table {
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--card-border);
            font-weight: 700;
        }
        
        .table thead th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            border: none;
            padding: 16px 20px;
            vertical-align: middle;
        }
        
        .table tbody td {
            padding: 14px 20px;
            font-weight: 700;
            vertical-align: middle;
            border-color: var(--gray-light);
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(236, 240, 241, 0.3);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.08);
            transform: scale(1.002);
            transition: transform 0.2s;
        }
        
        /* ====== أقسام الفلترة والبحث ====== */
        .filter-section, .search-filters {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
        }
        
        .filter-group {
            margin-bottom: 22px;
        }
        
        .filter-group label {
            font-weight: 800;
            margin-bottom: 10px;
            display: block;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        /* ====== حقول الإدخال ====== */
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid var(--gray-light);
            padding: 12px 16px;
            font-size: 1rem;
            font-weight: 700;
            transition: all var(--transition-speed);
            background: var(--card-bg);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.2);
            background: var(--card-bg);
        }
        
        /* ====== منطقة رفع الملفات ====== */
        .upload-area {
            border: 2px dashed var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 50px 30px;
            text-align: center;
            background: rgba(52, 152, 219, 0.05);
            transition: all var(--transition-speed);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 60%, rgba(52, 152, 219, 0.1) 100%);
            pointer-events: none;
        }
        
        .upload-area:hover {
            background: rgba(52, 152, 219, 0.1);
            border-color: var(--info-color);
            transform: translateY(-3px);
        }
        
        .upload-area i {
            font-size: 3.8rem;
            color: var(--secondary-color);
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* ====== شبكة الشهور ====== */
        .month-card {
            border: 2px dashed var(--gray-medium);
            border-radius: var(--border-radius);
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            background: var(--card-bg);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .month-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-secondary);
            transform: scaleX(0);
            transition: transform 0.4s;
        }
        
        .month-card:hover {
            border-color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.03);
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
        }
        
        .month-card:hover::before {
            transform: scaleX(1);
        }
        
        .month-card.uploaded {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.05);
        }
        
        .month-card.uploaded::before {
            background: var(--gradient-success);
            transform: scaleX(1);
        }
        
        .month-card.uploading {
            border-color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .month-card.uploading::before {
            background: var(--gradient-secondary);
            transform: scaleX(1);
        }
        
        .month-card i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .month-card.uploaded i {
            color: var(--success-color);
        }
        
        .month-card.uploading i {
            color: var(--secondary-color);
            animation: spin 1s linear infinite;
        }
        
        /* ====== التوقيع ====== */
        .signature {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.3rem !important;
            color: var(--primary-color);
            margin-top: 40px;
            padding-top: 20px;
            display: inline-block;
            font-weight: 900;
            text-align: left !important;
            float: left !important;
            border-top: 3px solid var(--accent-color);
            padding-right: 15px;
        }
        
        /* ====== رأس التقرير ====== */
        .report-header {
            background: var(--gradient-primary) !important;
            color: #FFFFFF;
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .report-header h2, .report-header h3 {
            color: #FFFFFF;
            font-weight: 900;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* ====== نتائج البحث ====== */
        .address-search-results, .doctors-search-results, .doctor-autocomplete-results {
            max-height: 450px;
            overflow-y: auto;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            margin-top: 15px;
            box-shadow: var(--card-shadow);
            position: absolute;
            z-index: 1000;
            width: calc(100% - 30px);
            display: none;
        }
        
        .address-search-item, .doctor-search-item, .doctor-autocomplete-item {
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: background-color 0.2s;
            background: var(--card-bg);
        }
        
        .address-search-item:hover, .doctor-search-item:hover, .doctor-autocomplete-item:hover {
            background: rgba(52, 152, 219, 0.05);
        }
        
        .address-search-item.selected, .doctor-search-item.selected, .doctor-autocomplete-item.selected {
            background: rgba(39, 174, 96, 0.08);
            border-right: 4px solid var(--success-color);
        }
        
        /* ====== بطاقات العنوان ====== */
        .address-stat-card {
            background: var(--gradient-info);
            color: white;
            border-radius: var(--border-radius);
            padding: 30px 25px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: all var(--transition-speed);
            position: relative;
            overflow: hidden;
        }
        
        .address-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(22, 160, 133, 0.2);
        }
        
        .address-stat-card .number {
            font-size: 2.8rem;
            font-weight: 900;
        }
        
        .address-stat-card .label {
            font-size: 1.2rem;
            opacity: 0.95;
        }
        
        /* ====== شارة التخصص ====== */
        .specialty-badge, .services-badge {
            margin: 4px;
            font-size: 0.9rem;
            background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
            color: white;
            border-radius: 20px;
            padding: 6px 14px;
            font-weight: 700;
            display: inline-block;
        }
        
        /* ====== تصنيف المنطقة ====== */
        .area-classification {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 900;
            margin-right: 5px;
            color: white;
        }
        
        .area-a {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
        }
        
        .area-b {
            background: linear-gradient(135deg, #F39C12, #D35400);
        }
        
        .area-c {
            background: linear-gradient(135deg, #27AE60, #229954);
        }
        
        /* ====== التقييم بالنجوم ====== */
        .star-rating {
            color: #FFD700;
            font-size: 1.4rem;
        }
        
        .gold-star {
            color: #FFD700;
        }
        
        .silver-star {
            color: #C0C0C0;
        }
        
        .bronze-star {
            color: #CD7F32;
        }
        
        /* ====== المؤشرات والتحميل ====== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 70px;
            height: 70px;
            border: 6px solid var(--gray-light);
            border-top: 6px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }
        
        .processing-indicator {
            text-align: center;
            padding: 40px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            margin-top: 25px;
            border: 1px solid var(--card-border);
            display: none;
        }
        
        .processing-indicator.active {
            display: block;
        }
        
        /* ====== التقدم والتحميل ====== */
        .progress {
            height: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            background-color: var(--gray-light);
            border: 1px solid var(--card-border);
            overflow: hidden;
        }
        
        .progress-bar {
            background: var(--gradient-secondary);
            line-height: 12px;
            font-weight: 900;
            border-radius: 6px;
            transition: width 0.6s ease;
        }
        
        /* ====== الرسوم البيانية ====== */
        .chart-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }
        
        /* ====== الخريطة ====== */
        .map-card {
            min-height: 400px;
            border-top: 4px solid var(--secondary-color);
        }
        
        .doctor-map-iframe {
            width: 100%;
            height: 350px;
            border: none;
            border-radius: var(--border-radius);
            border: 2px solid var(--gray-light);
        }
        
        /* ====== التحذيرات ====== */
        .memory-warning {
            background: linear-gradient(135deg, #FFF3CD, #FFEEBA);
            border: 2px solid #FFC107;
            color: #856404;
            padding: 18px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-size: 1rem;
            font-weight: 700;
            display: none;
        }
        
        .memory-warning.show {
            display: block;
        }
        
        /* ====== الأنيميشن ====== */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ====== تنسيقات الطباعة ====== */
        @media print {
            @page {
                size: landscape;
                margin: 10mm;
            }
            
            body * {
                visibility: hidden;
            }
            #report-preview, #report-preview * {
                visibility: visible;
            }
            #report-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 10px;
                margin: 0;
                font-size: 10px !important;
                overflow: visible !important;
                font-weight: 900 !important;
            }
            .no-print {
                display: none !important;
            }
            .stat-card {
                page-break-inside: avoid;
                margin-bottom: 10px;
                padding: 15px 10px !important;
                font-weight: 900 !important;
            }
            .table {
                font-size: 9px !important;
                page-break-inside: avoid;
                width: 100% !important;
                table-layout: fixed !important;
                font-weight: 900 !important;
            }
            .table th, .table td {
                padding: 5px 8px !important;
                word-wrap: break-word !important;
                white-space: normal !important;
                overflow: visible !important;
                text-overflow: clip !important;
                line-height: 1.2 !important;
                font-weight: 900 !important;
            }
            .address-report-table th,
            .address-report-table td {
                padding: 4px 6px !important;
                font-size: 8px !important;
                font-weight: 900 !important;
            }
            .report-header {
                padding: 15px !important;
                margin-bottom: 15px !important;
                font-size: 14px !important;
                font-weight: 900 !important;
            }
            .address-stat-card {
                padding: 15px 10px !important;
                margin-bottom: 10px !important;
                font-weight: 900 !important;
            }
            .address-stat-card .number {
                font-size: 1.8rem !important;
                font-weight: 900 !important;
            }
            .address-stat-card .label {
                font-size: 0.9rem !important;
                font-weight: 900 !important;
            }
            .signature {
                margin-top: 20px !important;
                padding-top: 10px !important;
                font-size: 1rem !important;
                font-weight: 900 !important;
            }
            #report-charts-section {
                page-break-inside: avoid;
            }
            h1, h2, h3, h4 {
                margin: 5px 0 !important;
                font-size: 1.2em !important;
                font-weight: 900 !important;
            }
            .card {
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                margin-bottom: 10px !important;
            }
            .card-header {
                padding: 8px 10px !important;
                font-size: 1em !important;
                font-weight: 900 !important;
            }
            .card-body {
                padding: 10px !important;
            }
            .row {
                margin: 0 !important;
            }
            .col-md-1, .col-md-2, .col-md-3, .col-md-4, 
            .col-md-5, .col-md-6, .col-md-7, .col-md-8, 
            .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
                padding: 5px !important;
            }
            .month-cell {
                min-width: 30px !important;
                font-size: 8px !important;
                font-weight: 900 !important;
            }
            /* إصلاح عرض الجداول في الطباعة */
            table {
                width: 100% !important;
                table-layout: fixed !important;
            }
            th, td {
                max-width: none !important;
                min-width: 40px !important;
                font-weight: 900 !important;
            }
            /* منع تكسير النصوص الطويلة */
            td, th {
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                font-weight: 900 !important;
            }
            /* الرسوم البيانية كصور */
            canvas {
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid !important;
            }
            /* زيادة دقة الصور */
            img {
                max-width: 100% !important;
                height: auto !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* ====== تحسينات للأجهزة المحمولة ====== */
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
                margin-bottom: 20px;
                position: relative;
                width: 100%;
            }
            
            .stat-card .number {
                font-size: 1.8rem;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
            
            .upload-area i {
                font-size: 2.8rem;
            }
            
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .card-header {
                padding: 15px 20px;
                font-size: 1.1rem;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .doctor-stat-card {
                padding: 20px 15px;
            }
            
            .doctor-stat-card .number {
                font-size: 2rem;
            }
            
            .form-control, .form-select {
                padding: 10px 14px;
                font-size: 0.95rem;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
            
            h1, h2, h3 {
                font-size: 1.5rem;
            }
            
            .month-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .month-card {
                min-height: 120px;
                padding: 20px 10px;
            }
            
            .month-card i {
                font-size: 1.8rem;
            }
            
            .report-header {
                padding: 20px 15px;
            }
            
            .address-search-results, .doctors-search-results, .doctor-autocomplete-results {
                max-height: 300px;
            }
            
            .doctor-details-section .row > div {
                margin-bottom: 15px;
            }
            
            .doctor-charts-section .row > div {
                margin-bottom: 20px;
            }
            
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-stack > div {
                width: 100% !important;
                margin-bottom: 15px;
            }
            
            .mobile-hide {
                display: none !important;
            }
        }
        
        @media (max-width: 480px) {
            .month-grid {
                grid-template-columns: repeat(1, 1fr) !important;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
            
            .card-header {
                padding: 12px 15px;
                font-size: 1rem;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
            
            .stat-card .number {
                font-size: 1.6rem;
            }
            
            h1, h2, h3 {
                font-size: 1.3rem;
            }
            
            .table-responsive {
                margin-left: -15px;
                margin-right: -15px;
                padding-left: 15px;
                padding-right: 15px;
            }
        }
        
        /* ====== شريط التمرير ====== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2980B9, var(--secondary-color));
        }
        
        /* ====== تأثيرات إضافية ====== */
        .main-content {
            padding: 30px 0;
        }
        
        .border-bottom {
            border-bottom: 2px solid var(--gray-light) !important;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .badge {
            border-radius: 20px;
            padding: 7px 14px;
            font-weight: 700;
        }
        
        .modal-content {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 25px;
        }
        
        .btn-close {
            filter: invert(1) brightness(2);
        }
        
        /* ====== تنسيقات جديدة للبحث المتقدم ====== */
        .advanced-search-options {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 20px;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }
        
        .search-stats {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            font-size: 1rem;
            border: 1px solid var(--card-border);
        }
        
        .search-time {
            color: var(--success-color);
            font-weight: 900;
        }
        
        /* ====== نسبة المطابقة ====== */
        .match-percentage {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--card-bg);
            color: var(--primary-color);
            margin-right: 8px;
            font-weight: 700;
            border: 1px solid var(--card-border);
            display: inline-block;
        }
        
        .high-match {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.15), rgba(39, 174, 96, 0.05)) !important;
            color: var(--success-color) !important;
            border-color: rgba(39, 174, 96, 0.3) !important;
        }
        
        .medium-match {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.15), rgba(243, 156, 18, 0.05)) !important;
            color: var(--warning-color) !important;
            border-color: rgba(243, 156, 18, 0.3) !important;
        }
        
        .low-match {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(231, 76, 60, 0.05)) !important;
            color: var(--accent-color) !important;
            border-color: rgba(231, 76, 60, 0.3) !important;
        }
        
        /* ====== شارة الطبيب المحدد ====== */
        .selected-doctor-badge {
            margin: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            font-weight: 700;
            color: var(--primary-color);
            transition: all var(--transition-speed);
        }
        
        .selected-doctor-badge:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(52, 152, 219, 0.1));
            transform: translateY(-2px);
        }
        
        .selected-doctor-badge .remove-doctor {
            margin-right: 10px;
            cursor: pointer;
            color: var(--accent-color);
            font-size: 1.1rem;
            transition: all var(--transition-speed);
        }
        
        .selected-doctor-badge .remove-doctor:hover {
            transform: scale(1.2);
        }
        
        /* ====== بطاقة ملخص الطبيب ====== */
        .doctor-summary-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            overflow: hidden;
            border: 1px solid var(--card-border);
            border-top: 4px solid var(--secondary-color);
        }
        
        .doctor-summary-header {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            padding: 25px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .doctor-summary-body {
            padding: 25px;
        }
        
        /* ====== إزالة الفرز التلقائي ====== */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0px 1000px var(--card-bg) inset;
            box-shadow: 0 0 0px 1000px var(--card-bg) inset;
            transition: background-color 5000s ease-in-out 0s;
            color: var(--dark-color) !important;
        }
        
        /* ====== تلميحات الأدوات ====== */
        [title] {
            position: relative;
            cursor: help;
        }
        
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* ====== تأثيرات الرفع ====== */
        .upload-options, .large-file-optimization {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 25px;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }
        
        .worker-status {
            padding: 15px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            border-radius: var(--border-radius);
            font-size: 1rem;
            margin-top: 20px;
            border: 1px solid rgba(52, 152, 219, 0.2);
            color: var(--secondary-color);
            font-weight: 700;
        }
        
        /* ====== تحسينات الأداء ====== */
        .fast-search-index {
            display: none;
        }
        
        .address-index-stats {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-size: 0.95rem;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }
        
        /* ====== ألوان متنوعة للبطاقات الإحصائية ====== */
        .stat-card:nth-child(2) i,
        .stat-card:nth-child(2)::before {
            background: linear-gradient(135deg, var(--info-color), #16A085);
        }
        
        .stat-card:nth-child(3) i,
        .stat-card:nth-child(3)::before {
            background: linear-gradient(135deg, var(--accent-color), #C0392B);
        }
        
        .stat-card:nth-child(4) i,
        .stat-card:nth-child(4)::before {
            background: linear-gradient(135deg, var(--warning-color), #D35400);
        }
        
        .stat-card:nth-child(5) i,
        .stat-card:nth-child(5)::before {
            background: linear-gradient(135deg, #9B59B6, #8E44AD);
        }
        
        .stat-card:nth-child(6) i,
        .stat-card:nth-child(6)::before {
            background: linear-gradient(135deg, #1ABC9C, #16A085);
        }
        
        /* ====== رسوم بيانية عالية الدقة للطباعة ====== */
        .print-chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .print-chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* ====== تنسيقات النصوص والأرقام ====== */
        strong, b, .bold-text {
            font-weight: 900 !important;
        }
        
        .number-bold {
            font-weight: 900 !important;
            font-size: 1.1em;
        }
        
        /* ====== تحسينات للبحث ====== */
        .search-perf-info {
            background: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            font-size: 0.9rem;
            border: 1px solid var(--card-border);
        }
        
        .month-search-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 5px;
            background: var(--gray-light);
            color: var(--dark-color);
        }
        
        .month-search-status.found {
            background: var(--success-color);
            color: white;
        }
        
        .month-search-status.not-found {
            background: var(--gray-medium);
            color: white;
        }
        
        /* ====== بطاقات إحصائيات الطبيب الجديدة ====== */
        .doctor-stat-card {
            text-align: center;
            padding: 25px 20px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--card-border);
            transition: all var(--transition-speed);
            position: relative;
            overflow: hidden;
            height: 100%;
        }
        
        .doctor-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
        }
        
        .doctor-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
        }
        
        .doctor-stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
            background: linear-gradient(135deg, var(--secondary-color), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .doctor-stat-card .number {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--primary-color);
            line-height: 1;
            margin: 10px 0;
        }
        
        .doctor-stat-card .label {
            font-size: 1rem;
            color: var(--gray-dark);
            font-weight: 700;
        }
        
        /* ====== قسم تفاصيل الطبيب ====== */
        .doctor-details-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }
        
        .doctor-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .doctor-info-label {
            font-weight: 800;
            color: var(--primary-color);
            min-width: 120px;
        }
        
        .doctor-info-value {
            font-weight: 700;
            color: var(--dark-color);
            flex: 1;
            text-align: left;
        }
        
        /* ====== قسم رسوم الطبيب البيانية ====== */
        .doctor-charts-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }
        
        .doctor-chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-bottom: 25px;
        }
        
        /* ====== التكملة التلقائية ====== */
        .autocomplete-container {
            position: relative;
        }
        
        /* ====== محاذاة النص للجوال ====== */
        .text-center-mobile {
            text-align: center !important;
        }
        
        @media (max-width: 768px) {
            .text-center-mobile {
                text-align: center !important;
            }
            
            .text-right-mobile {
                text-align: right !important;
            }
            
            .text-left-mobile {
                text-align: left !important;
            }
            
            .d-block-mobile {
                display: block !important;
            }
            
            .w-100-mobile {
                width: 100% !important;
            }
            
            .mb-3-mobile {
                margin-bottom: 1rem !important;
            }
            
            .px-3-mobile {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
        }
    </style>
</head>
<body>
    <!-- شريط التنقل -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-clinic-medical me-2"></i>
                مركز المامون الطبي التشخيصي
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-user me-1"></i> سام جميل القدسي</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-sign-out-alt me-1"></i> تسجيل الخروج</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- الشريط الجانبي -->
            <div class="col-lg-2 col-md-3 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('upload-settings-section')">
                                <i class="fas fa-cog"></i>
                                الإعدادات ورفع الملفات
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('reports-section')">
                                <i class="fas fa-file-alt"></i>
                                التقارير
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('doctor-report-section')">
                                <i class="fas fa-user-md"></i>
                                تقرير الطبيب
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- المحتوى الرئيسي -->
            <div class="col-lg-10 col-md-9 ms-sm-auto px-md-4 main-content">
                <!-- قسم الإعدادات ورفع الملفات -->
                <div id="upload-settings-section" class="content-section" style="display: none;">
                    <!-- محتوى الإعدادات والرفع -->
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">الإعدادات ورفع ملفات الأطباء</h1>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-file-excel me-2"></i> رفع ملفات بيانات الأطباء (12 شهر) - محسّن
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="doctors-year" class="form-label">السنة:</label>
                                        <input type="number" class="form-control" id="doctors-year" value="2025" min="2020" max="2030" autocomplete="off">
                                    </div>
                                    
                                    <div class="month-grid" id="doctors-month-grid">
                                        <!-- سيتم ملؤها بالشهور -->
                                    </div>
                                    
                                    <div class="large-file-optimization mt-3">
                                        <h6><i class="fas fa-chart-line me-2"></i>تحسينات تحليل بيانات الأطباء</h6>
                                        <div class="optimization-option">
                                            <input type="checkbox" id="enable-doctors-cache" checked autocomplete="off">
                                            <label for="enable-doctors-cache">تفعيل التخزين المؤقت لبيانات الأطباء</label>
                                        </div>
                                        <div class="optimization-option">
                                            <input type="checkbox" id="enable-doctors-index" checked autocomplete="off">
                                            <label for="enable-doctors-index">تفعيل الفهرسة السريعة للبيانات</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <label for="doctors-set-name" class="form-label">تعيين اسم قاعدة ملفات الأطباء:</label>
                                        <input type="text" class="form-control" id="doctors-set-name" placeholder="أدخل اسم قاعدة ملفات الأطباء" autocomplete="off">
                                    </div>
                                    <button class="btn btn-success mt-3 w-100" id="process-all-doctors">
                                        <i class="fas fa-cog me-2"></i> معالجة جميع بيانات الأطباء (محسّنة)
                                    </button>
                                    
                                    <div class="processing-indicator" id="doctors-processing">
                                        <div class="spinner"></div>
                                        <p>جاري معالجة بيانات الأطباء، يرجى الانتظار...</p>
                                        <div class="progress mt-3">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <div class="analysis-stats">
                                            <span id="processed-doctors">0 طبيب</span>
                                            <span id="doctors-speed">0 طبيب/ثانية</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="fas fa-history me-2"></i> الملفات المرفوعة حديثاً
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>اسم الملف</th>
                                            <th>النوع</th>
                                            <th>الحجم</th>
                                            <th>تاريخ الرفع</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="uploaded-files-list">
                                        <!-- سيتم ملؤها بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-cog me-2"></i> إعدادات النظام
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="interaction-levels" class="form-label">مستويات التفاعل:</label>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text" style="background: linear-gradient(135deg, #E74C3C, #C0392B); color: white;">منخفض</span>
                                            <input type="number" class="form-control" id="low-min" value="0" min="0" autocomplete="off">
                                            <span class="input-group-text">-</span>
                                            <input type="number" class="form-control" id="low-max" value="20" min="0" autocomplete="off">
                                            <span class="input-group-text">حالة</span>
                                        </div>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text" style="background: linear-gradient(135deg, #F39C12, #D35400); color: white;">متوسط</span>
                                            <input type="number" class="form-control" id="medium-min" value="21" min="0" autocomplete="off">
                                            <span class="input-group-text">-</span>
                                            <input type="number" class="form-control" id="medium-max" value="50" min="0" autocomplete="off">
                                            <span class="input-group-text">حالة</span>
                                        </div>
                                        <div class="input-group">
                                            <span class="input-group-text" style="background: linear-gradient(135deg, #27AE60, #229954); color: white;">مرتفع</span>
                                            <input type="number" class="form-control" id="high-min" value="51" min="0" autocomplete="off">
                                            <span class="input-group-text">-</span>
                                            <input type="number" class="form-control" id="high-max" value="1000" min="0" autocomplete="off">
                                            <span class="input-group-text">حالة</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="saveInteractionLevels()">حفظ الإعدادات</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-database me-2"></i> إدارة البيانات
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <button class="btn btn-outline-primary w-100" onclick="resetData()">
                                                <i class="fas fa-sync-alt me-2"></i> إعادة تعيين البيانات
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <button class="btn btn-outline-success w-100" onclick="backupData()">
                                                <i class="fas fa-download me-2"></i> نسخ احتياطي للبيانات
                                            </button>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <button class="btn btn-outline-info w-100" onclick="restoreData()">
                                                <i class="fas fa-upload me-2"></i> استعادة البيانات
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم التقارير -->
                <div id="reports-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">التقارير</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-primary me-2" onclick="generateReport()">
                                <i class="fas fa-plus me-1"></i> إنشاء تقرير جديد
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-filter me-2"></i> معايير البحث
                                </div>
                                <div class="card-body">
                                    <div class="search-filters">
                                        <!-- قسم البحث بالعنوان - تم التحسين -->
                                        <div class="filter-group">
                                            <label for="address-search" class="form-label">بحث بالعنوان:</label>
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" id="address-search" placeholder="أدخل جزء من العنوان للبحث" autocomplete="off">
                                                <button class="btn btn-primary" onclick="searchByAddress()">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                            <div class="search-perf-info" id="search-perf-info" style="display: none;">
                                                <!-- معلومات أداء البحث ستظهر هنا -->
                                            </div>
                                            <div class="search-stats" id="address-search-stats" style="display: none;">
                                                <!-- إحصائيات البحث ستظهر هنا -->
                                            </div>
                                            <small class="text-muted">البحث لا يتحسس لحالة الأحرف (كبير/صغير)</small>
                                            
                                            <!-- فلاتر إضافية لتقرير العنوان -->
                                            <div class="address-filters mt-3" id="address-filters" style="display: none;">
                                                <h6><i class="fas fa-filter me-2"></i>فلاتر إضافية</h6>
                                                <div class="row mb-2">
                                                    <div class="col-md-6">
                                                        <label for="address-filter-rep" class="form-label">المندوب:</label>
                                                        <select class="form-select" id="address-filter-rep" onchange="applyAddressFilters()" autocomplete="off">
                                                            <option value="all">جميع المندوبين</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="address-filter-area" class="form-label">المنطقة:</label>
                                                        <select class="form-select" id="address-filter-area" onchange="applyAddressFilters()" autocomplete="off">
                                                            <option value="all">جميع المناطق</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <label for="address-filter-specialty" class="form-label">التخصص:</label>
                                                        <select class="form-select" id="address-filter-specialty" onchange="applyAddressFilters()" autocomplete="off">
                                                            <option value="all">جميع التخصصات</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- زر اختيار جميع نتائج البحث -->
                                            <button class="btn btn-success w-100 select-all-results-btn" onclick="selectAllDoctorsFromAddressSearch()" style="display: none;" id="select-all-results-btn">
                                                <i class="fas fa-users me-1"></i> اختيار جميع الأطباء في نتائج البحث
                                            </button>
                                            
                                            <div id="address-search-results" class="address-search-results" style="display: none;">
                                                <!-- نتائج البحث تظهر هنا -->
                                            </div>
                                            
                                            <div class="selected-doctors-container mt-3" id="address-selected-doctors">
                                                <!-- الأطباء المحددين للتقارير -->
                                            </div>
                                            
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-danger w-100" onclick="clearSelectedDoctorsForAddressReport()">
                                                    <i class="fas fa-times me-1"></i> مسح جميع الأطباء المحددين
                                                </button>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="filter-group">
                                                    <label for="report-date-from" class="form-label">من تاريخ:</label>
                                                    <input type="date" class="form-control" id="report-date-from" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="filter-group">
                                                    <label for="report-date-to" class="form-label">إلى تاريخ:</label>
                                                    <input type="date" class="form-control" id="report-date-to" autocomplete="off">
                                                </div>
                                            </div>
                                        </div>

                                        <button class="btn btn-success w-100 mt-3" onclick="generateAddressReport()">
                                            <i class="fas fa-file-alt me-2"></i> إنشاء التقرير
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-file-pdf me-2"></i> معاينة التقرير</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="printReport()">
                                            <i class="fas fa-print me-1"></i> طباعة
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="exportToExcel()">
                                            <i class="fas fa-file-excel me-1"></i> Excel
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="report-preview">
                                        <div class="text-center text-muted py-5">
                                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                                            <p>لم يتم إنشاء تقرير بعد. استخدم الإعدادات على اليسار لإنشاء تقرير.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- قسم الرسوم البيانية للتقرير -->
                            <div class="card mt-4" id="report-charts-section" style="display: none;">
                                <div class="card-header">
                                    <i class="fas fa-chart-bar me-2"></i> الرسوم البيانية للتقرير
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-4">
                                            <div class="print-chart-container">
                                                <canvas id="report-chart-1" height="250"></canvas>
                                            </div>
                                            <div class="text-center mt-2">
                                                <strong>إجمالي عدد الحالات لكل شهر</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <div class="print-chart-container">
                                                <canvas id="report-chart-2" height="250"></canvas>
                                            </div>
                                            <div class="text-center mt-2">
                                                <strong>عدد الأطباء لكل مندوب</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <div class="print-chart-container">
                                                <canvas id="report-chart-3" height="250"></canvas>
                                            </div>
                                            <div class="text-center mt-2">
                                                <strong>توزيع التخصصات بعدد الأطباء</strong>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <div class="print-chart-container">
                                                <canvas id="report-chart-4" height="250"></canvas>
                                            </div>
                                            <div class="text-center mt-2">
                                                <strong>توزيع التخصصات بعدد الحالات</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم تقرير الطبيب الجديد -->
                <div id="doctor-report-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">تقرير الطبيب المفصل</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-primary me-2" onclick="printDoctorReport()">
                                <i class="fas fa-print me-1"></i> طباعة التقرير
                            </button>
                        </div>
                    </div>

                    <!-- قسم البحث عن الطبيب -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-search me-2"></i> البحث عن الطبيب
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="autocomplete-container">
                                                <label for="doctor-search-input" class="form-label">اسم الطبيب:</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="doctor-search-input" 
                                                           placeholder="ابدأ بكتابة اسم الطبيب للبحث التلقائي..." 
                                                           autocomplete="off" oninput="searchDoctorsAutocomplete()">
                                                    <button class="btn btn-primary" onclick="searchDoctor()">
                                                        <i class="fas fa-search"></i> بحث
                                                    </button>
                                                </div>
                                                <div id="doctor-autocomplete-results" class="doctor-autocomplete-results"></div>
                                                <small class="text-muted mt-2 d-block">اكتب اسم الطبيب أو جزء منه لعرض التكملة التلقائية</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="doctor-specialty-filter" class="form-label">التخصص:</label>
                                            <select class="form-select" id="doctor-specialty-filter" onchange="filterDoctorsBySpecialty()" autocomplete="off">
                                                <option value="all">جميع التخصصات</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3" id="search-doctor-stats" style="display: none;">
                                        <div class="col-md-12">
                                            <div class="search-stats">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <span id="doctor-search-count">0</span> نتيجة بحث |
                                                <span id="doctor-search-time">0</span> ثانية
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- إحصائيات الطبيب -->
                    <div class="row mb-4" id="doctor-stats-section" style="display: none;">
                        <div class="col-md-12">
                            <h3 class="mb-4">إحصائيات الطبيب</h3>
                            <div class="row">
                                <div class="col-md-3 col-sm-6 mb-4">
                                    <div class="doctor-stat-card">
                                        <i class="fas fa-user-md"></i>
                                        <div class="number" id="total-cases">0</div>
                                        <div class="label">إجمالي الحالات</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-4">
                                    <div class="doctor-stat-card">
                                        <i class="fas fa-calendar-alt"></i>
                                        <div class="number" id="active-months">0</div>
                                        <div class="label">أشهر النشاط</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-4">
                                    <div class="doctor-stat-card">
                                        <i class="fas fa-chart-line"></i>
                                        <div class="number" id="avg-monthly-cases">0</div>
                                        <div class="label">متوسط الحالات شهرياً</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-4">
                                    <div class="doctor-stat-card">
                                        <i class="fas fa-star"></i>
                                        <div class="number" id="performance-rating">0</div>
                                        <div class="label">التقييم</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تفاصيل الطبيب -->
                    <div class="row mb-4" id="doctor-details-section" style="display: none;">
                        <div class="col-md-12">
                            <div class="doctor-details-section">
                                <h3 class="mb-4">تفاصيل الطبيب</h3>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="doctor-info-row">
                                            <span class="doctor-info-label">اسم الطبيب:</span>
                                            <span class="doctor-info-value" id="doctor-name">غير محدد</span>
                                        </div>
                                        <div class="doctor-info-row">
                                            <span class="doctor-info-label">رقم الطبيب:</span>
                                            <span class="doctor-info-value" id="doctor-id">غير محدد</span>
                                        </div>
                                        <div class="doctor-info-row">
                                            <span class="doctor-info-label">التخصص:</span>
                                            <span class="doctor-info-value" id="doctor-specialty">غير محدد</span>
                                        </div>
                                        <div class="doctor-info-row">
                                            <span class="doctor-info-label">المندوب:</span>
                                            <span class="doctor-info-value" id="doctor-rep">غير محدد</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="doctor-info-row">
                                            <span class="doctor-info-label">العنوان:</span>
                                            <span class="doctor-info-value" id="doctor-address">غير محدد</span>
                                        </div>
                                        <div class="doctor-info-row">
                                            <span class="doctor-info-label">المنطقة:</span>
                                            <span class="doctor-info-value" id="doctor-area">غير محدد</span>
                                        </div>
                                        <div class="doctor-info-row">
                                            <span class="doctor-info-label">الهاتف:</span>
                                            <span class="doctor-info-value" id="doctor-phone">غير محدد</span>
                                        </div>
                                        <div class="doctor-info-row">
                                            <span class="doctor-info-label">تاريخ أول حالة:</span>
                                            <span class="doctor-info-value" id="first-case-date">غير محدد</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- رسوم بيانية للطبيب -->
                    <div class="row mb-4" id="doctor-charts-section" style="display: none;">
                        <div class="col-md-12">
                            <div class="doctor-charts-section">
                                <h3 class="mb-4">الرسوم البيانية للحالات الشهرية</h3>
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="doctor-chart-container">
                                            <canvas id="doctor-monthly-chart"></canvas>
                                        </div>
                                        <div class="text-center mt-2">
                                            <strong>عدد الحالات لكل شهر</strong>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="doctor-chart-container">
                                            <canvas id="doctor-trend-chart"></canvas>
                                        </div>
                                        <div class="text-center mt-2">
                                            <strong>اتجاه الحالات خلال السنة</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>الشهر</th>
                                                        <th>عدد الحالات</th>
                                                        <th>النسبة المئوية</th>
                                                        <th>المعدل اليومي</th>
                                                        <th>المقارنة مع المتوسط</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="doctor-monthly-table">
                                                    <!-- سيتم ملؤها بالبيانات -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تقرير الطبيب للطباعة -->
                    <div id="doctor-report-print" style="display: none;">
                        <!-- سيتم ملؤها عند الطباعة -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة الخدمات المنبثقة -->
    <div class="modal fade" id="servicesModal" tabindex="-1" aria-labelledby="servicesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="servicesModalLabel">تفاصيل الخدمات للطبيب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="servicesModalContent">
                        <!-- سيتم ملؤها بالبيانات -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة التحميل -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="mt-3">جاري معالجة البيانات، يرجى الانتظار...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // البيانات المخزنة محلياً
        let doctorsData = [];
        let currentReportData = [];
        let uploadedFiles = [];
        
        // البيانات الخاصة بملفات الأطباء حسب الشهر
        let doctorsMonthlyData = {};
        
        // الرسوم البيانية للتقرير
        let reportChart1, reportChart2, reportChart3, reportChart4;
        let chartImagesForPrint = {};
        
        // المتغيرات الجديدة لتقرير العنوان
        let addressSearchResults = [];
        let addressSelectedDoctors = [];
        let allSearchDoctors = []; // جميع الأطباء في نتائج البحث الحالية
        let filteredSearchDoctors = []; // الأطباء بعد التصفية
        
        // المتغيرات الجديدة لتقرير الطبيب
        let currentDoctor = null;
        let doctorSearchCache = {};
        let doctorNameIndex = new Map(); // فهرس سريع لأسماء الأطباء
        let doctorSpecialtyIndex = new Map(); // فهرس سريع للتخصصات
        let doctorAutocompleteResults = [];
        let doctorChart1, doctorChart2;
        
        // تحسينات للملفات الكبيرة
        let isProcessingLargeFile = false;
        
        // فهارس البحث السريع - محسنة بشكل كبير
        let addressSearchCache = {};
        
        // فهرس سريع للعناوين (جديد)
        let fastAddressIndexByMonth = new Map(); // Map لكل شهر
        
        // إعدادات البحث - محسنة
        const searchSettings = {
            minMatchPercentage: 30,
            enableFuzzySearch: false,
            enableIndexing: true,
            maxResults: 200,
            cacheSize: 100
        };
        
        // إدارة تخزين البيانات - جديدة
        const storageManager = {
            maxLocalStorageSize: 5 * 1024 * 1024, // 5MB
            compressedDataKey: 'compressedData',
            
            // التحقق من سعة التخزين
            checkStorageSpace() {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    return true;
                } catch (e) {
                    return false;
                }
            },
            
            // ضغط البيانات قبل التخزين
            compressData(data) {
                try {
                    return LZString.compressToUTF16(JSON.stringify(data));
                } catch (e) {
                    console.error('خطأ في ضغط البيانات:', e);
                    return JSON.stringify(data);
                }
            },
            
            // فك ضغط البيانات
            decompressData(compressedData) {
                try {
                    if (compressedData.startsWith('{') || compressedData.startsWith('[')) {
                        return JSON.parse(compressedData);
                    }
                    return JSON.parse(LZString.decompressFromUTF16(compressedData));
                } catch (e) {
                    console.error('خطأ في فك ضغط البيانات:', e);
                    return null;
                }
            },
            
            // حفظ البيانات مع ضغط
            saveData(key, data) {
                try {
                    const compressed = this.compressData(data);
                    localStorage.setItem(key, compressed);
                    return true;
                } catch (e) {
                    console.error(`خطأ في حفظ البيانات للمفتاح ${key}:`, e);
                    return false;
                }
            },
            
            // تحميل البيانات مع فك الضغط
            loadData(key) {
                try {
                    const compressed = localStorage.getItem(key);
                    if (!compressed) return null;
                    return this.decompressData(compressed);
                } catch (e) {
                    console.error(`خطأ في تحميل البيانات للمفتاح ${key}:`, e);
                    return null;
                }
            },
            
            // تنظيف البيانات القديمة
            cleanupOldData() {
                try {
                    // تنظيف ذاكرة التخزين المؤقت للبحث
                    if (Object.keys(addressSearchCache).length > 50) {
                        const cacheKeys = Object.keys(addressSearchCache);
                        const half = Math.floor(cacheKeys.length / 2);
                        for (let i = 0; i < half; i++) {
                            delete addressSearchCache[cacheKeys[i]];
                        }
                    }
                    
                    // تنظيف فهارس البحث
                    if (fastAddressIndexByMonth.size > 12) {
                        // الاحتفاظ فقط بأحدث 12 شهر
                        const monthKeys = Array.from(fastAddressIndexByMonth.keys());
                        monthKeys.sort();
                        const monthsToKeep = monthKeys.slice(-12);
                        
                        for (const key of monthKeys) {
                            if (!monthsToKeep.includes(key)) {
                                fastAddressIndexByMonth.delete(key);
                            }
                        }
                    }
                    
                    return true;
                } catch (e) {
                    console.error('خطأ في تنظيف البيانات القديمة:', e);
                    return false;
                }
            }
        };
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل البيانات المخزنة محلياً (إن وجدت)
            loadStoredData();
            
            // تحميل إعدادات مستويات التفاعل
            loadInteractionLevels();
            
            // تحميل قائمة الملفات المرفوعة
            loadUploadedFiles();
            
            // إنشاء شبكة الشهور
            createMonthGrid();
            
            // عرض القسم الافتراضي (تقرير الطبيب)
            showSection('doctor-report-section');
            
            // إعداد مستمعي الأحداث الجديدة
            setupSearchEventListeners();
            
            // إعداد معالجة بيانات الأطباء
            document.getElementById('process-all-doctors').addEventListener('click', processAllDoctorsData);
            document.getElementById('doctors-year').addEventListener('change', function() {
                createMonthGrid();
            });
            
            // إعداد رفع الملفات
            setupFileUploads();
            
            // إعداد أحداث البحث عن الطبيب
            setupDoctorSearchEvents();
            
            // بناء فهارس البحث السريعة للأطباء
            buildDoctorSearchIndexes();
        });
        
        // بناء فهارس البحث السريعة للأطباء
        function buildDoctorSearchIndexes() {
            doctorNameIndex.clear();
            doctorSpecialtyIndex.clear();
            
            if (doctorsData.length === 0) return;
            
            // بناء فهرس الأسماء
            for (let i = 0; i < doctorsData.length; i++) {
                const doctor = doctorsData[i];
                const doctorName = doctor.doctorName ? doctor.doctorName.toLowerCase().trim() : '';
                const doctorId = doctor.doctorId || '';
                
                if (doctorName && doctorId) {
                    // إضافة الاسم الكامل
                    if (!doctorNameIndex.has(doctorName)) {
                        doctorNameIndex.set(doctorName, []);
                    }
                    // تجنب تكرار نفس الطبيب
                    const existingIds = doctorNameIndex.get(doctorName).map(d => d.doctorId);
                    if (!existingIds.includes(doctorId)) {
                        doctorNameIndex.get(doctorName).push(doctor);
                    }
                    
                    // إضافة أجزاء الاسم (الكلمات الفردية)
                    const nameParts = doctorName.split(/\s+/);
                    for (let j = 0; j < nameParts.length; j++) {
                        const part = nameParts[j];
                        if (part.length > 2) { // تجاهل الكلمات القصيرة
                            if (!doctorNameIndex.has(part)) {
                                doctorNameIndex.set(part, []);
                            }
                            if (!doctorNameIndex.get(part).some(d => d.doctorId === doctorId)) {
                                doctorNameIndex.get(part).push(doctor);
                            }
                        }
                    }
                }
                
                // بناء فهرس التخصصات
                const specialty = doctor.specialty ? doctor.specialty.toLowerCase().trim() : '';
                if (specialty) {
                    if (!doctorSpecialtyIndex.has(specialty)) {
                        doctorSpecialtyIndex.set(specialty, []);
                    }
                    if (!doctorSpecialtyIndex.get(specialty).some(d => d.doctorId === doctorId)) {
                        doctorSpecialtyIndex.get(specialty).push(doctor);
                    }
                }
            }
            
            // تحديث قائمة التخصصات في الفلتر
            updateSpecialtyFilter();
            
            console.log(`تم بناء فهرس البحث: ${doctorNameIndex.size} كلمة مفتاحية، ${doctorSpecialtyIndex.size} تخصص`);
        }
        
        // تحديث فلتر التخصصات
        function updateSpecialtyFilter() {
            const specialtyFilter = document.getElementById('doctor-specialty-filter');
            specialtyFilter.innerHTML = '<option value="all">جميع التخصصات</option>';
            
            if (doctorSpecialtyIndex.size === 0) return;
            
            const specialties = Array.from(doctorSpecialtyIndex.keys())
                .map(s => s.charAt(0).toUpperCase() + s.slice(1))
                .sort();
            
            for (let i = 0; i < specialties.length; i++) {
                const option = document.createElement('option');
                option.value = specialties[i].toLowerCase();
                option.textContent = specialties[i];
                specialtyFilter.appendChild(option);
            }
        }
        
        // إعداد أحداث البحث عن الطبيب
        function setupDoctorSearchEvents() {
            const searchInput = document.getElementById('doctor-search-input');
            const autocompleteResults = document.getElementById('doctor-autocomplete-results');
            
            // البحث عند الضغط على Enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchDoctor();
                }
            });
            
            // إغلاق نتائج التكملة التلقائية عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
                    autocompleteResults.style.display = 'none';
                }
            });
            
            // عند اختيار نتيجة من التكملة التلقائية
            autocompleteResults.addEventListener('click', function(e) {
                const item = e.target.closest('.doctor-autocomplete-item');
                if (item) {
                    const doctorId = item.getAttribute('data-doctor-id');
                    if (doctorId) {
                        selectDoctorById(doctorId);
                    }
                }
            });
        }
        
        // البحث التلقائي عن الأطباء أثناء الكتابة
        function searchDoctorsAutocomplete() {
            const searchInput = document.getElementById('doctor-search-input');
            const searchTerm = searchInput.value.trim().toLowerCase();
            const autocompleteResults = document.getElementById('doctor-autocomplete-results');
            
            if (searchTerm.length < 2) {
                autocompleteResults.style.display = 'none';
                return;
            }
            
            if (doctorNameIndex.size === 0) {
                buildDoctorSearchIndexes();
            }
            
            const startTime = performance.now();
            const results = [];
            const seenDoctors = new Set();
            
            // البحث في الفهرس
            for (const [keyword, doctors] of doctorNameIndex.entries()) {
                if (keyword.includes(searchTerm)) {
                    for (let i = 0; i < doctors.length; i++) {
                        const doctor = doctors[i];
                        if (!seenDoctors.has(doctor.doctorId)) {
                            seenDoctors.add(doctor.doctorId);
                            results.push(doctor);
                        }
                    }
                }
            }
            
            // إذا لم توجد نتائج، جرب البحث التقريبي
            if (results.length === 0 && searchTerm.length >= 3) {
                const searchWords = searchTerm.split(/\s+/);
                
                for (const [keyword, doctors] of doctorNameIndex.entries()) {
                    let matchCount = 0;
                    for (let i = 0; i < searchWords.length; i++) {
                        if (keyword.includes(searchWords[i])) {
                            matchCount++;
                        }
                    }
                    
                    if (matchCount >= searchWords.length * 0.5) { // 50% تطابق
                        for (let i = 0; i < doctors.length; i++) {
                            const doctor = doctors[i];
                            if (!seenDoctors.has(doctor.doctorId)) {
                                seenDoctors.add(doctor.doctorId);
                                results.push(doctor);
                            }
                        }
                    }
                }
            }
            
            // تحديد النتائج (الحد الأقصى 10)
            const limitedResults = results.slice(0, 10);
            const searchTime = performance.now() - startTime;
            
            // عرض النتائج
            if (limitedResults.length > 0) {
                let html = '';
                for (let i = 0; i < limitedResults.length; i++) {
                    const doctor = limitedResults[i];
                    html += `
                        <div class="doctor-autocomplete-item" data-doctor-id="${doctor.doctorId}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${doctor.doctorName || 'غير معروف'}</strong>
                                    <div class="text-muted small">
                                        ${doctor.specialty || 'غير محدد'} | ${doctor.area || 'غير محدد'}
                                    </div>
                                </div>
                                <div>
                                    <small class="text-primary">${doctor.doctorId || 'غير محدد'}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                autocompleteResults.innerHTML = html;
                autocompleteResults.style.display = 'block';
            } else {
                autocompleteResults.innerHTML = `
                    <div class="doctor-autocomplete-item text-center text-muted p-3">
                        <i class="fas fa-search me-2"></i>
                        لا توجد نتائج
                    </div>
                `;
                autocompleteResults.style.display = 'block';
            }
            
            // تحديث إحصائيات البحث
            document.getElementById('doctor-search-count').textContent = limitedResults.length;
            document.getElementById('doctor-search-time').textContent = (searchTime / 1000).toFixed(3);
            document.getElementById('search-doctor-stats').style.display = 'block';
        }
        
        // تصفية الأطباء حسب التخصص
        function filterDoctorsBySpecialty() {
            const specialtyFilter = document.getElementById('doctor-specialty-filter');
            const selectedSpecialty = specialtyFilter.value.toLowerCase();
            
            if (selectedSpecialty === 'all') {
                // لا يوجد تصفية
                return;
            }
            
            // يمكن إضافة وظيفة التصفية هنا إذا لزم الأمر
        }
        
        // البحث عن طبيب محدد
        function searchDoctor() {
            const searchInput = document.getElementById('doctor-search-input');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert('يرجى إدخال اسم الطبيب للبحث');
                return;
            }
            
            if (doctorsData.length === 0) {
                alert('لم يتم تحميل بيانات الأطباء بعد. يرجى رفع ومعالجة ملفات الأطباء أولاً.');
                return;
            }
            
            // البحث في الفهرس أولاً
            const searchTermLower = searchTerm.toLowerCase();
            let foundDoctor = null;
            
            // البحث المباشر في الفهرس
            if (doctorNameIndex.has(searchTermLower)) {
                const doctors = doctorNameIndex.get(searchTermLower);
                if (doctors.length > 0) {
                    foundDoctor = doctors[0];
                }
            }
            
            // إذا لم يتم العثور، جرب البحث في جميع البيانات
            if (!foundDoctor) {
                for (let i = 0; i < doctorsData.length; i++) {
                    const doctor = doctorsData[i];
                    if (doctor.doctorName && doctor.doctorName.toLowerCase().includes(searchTermLower)) {
                        foundDoctor = doctor;
                        break;
                    }
                }
            }
            
            if (foundDoctor) {
                selectDoctorById(foundDoctor.doctorId);
            } else {
                alert('لم يتم العثور على طبيب بهذا الاسم. يرجى المحاولة مرة أخرى.');
            }
        }
        
        // اختيار طبيب حسب المعرف
        function selectDoctorById(doctorId) {
            // البحث عن الطبيب في البيانات
            let doctor = null;
            
            // البحث في البيانات المجمعة أولاً
            for (let i = 0; i < doctorsData.length; i++) {
                if (doctorsData[i].doctorId == doctorId) {
                    doctor = doctorsData[i];
                    break;
                }
            }
            
            if (!doctor) {
                // البحث في البيانات الشهرية
                for (const monthKey in doctorsMonthlyData) {
                    const monthData = doctorsMonthlyData[monthKey];
                    if (monthData && monthData.data) {
                        for (let i = 0; i < monthData.data.length; i++) {
                            if (monthData.data[i].doctorId == doctorId) {
                                doctor = monthData.data[i];
                                break;
                            }
                        }
                        if (doctor) break;
                    }
                }
            }
            
            if (!doctor) {
                alert('لم يتم العثور على بيانات الطبيب');
                return;
            }
            
            // تعيين الطبيب الحالي
            currentDoctor = doctor;
            
            // عرض تفاصيل الطبيب
            displayDoctorDetails(doctor);
            
            // إخفاء نتائج التكملة التلقائية
            document.getElementById('doctor-autocomplete-results').style.display = 'none';
            
            // مسح حقل البحث
            document.getElementById('doctor-search-input').value = doctor.doctorName || '';
        }
        
        // عرض تفاصيل الطبيب
        function displayDoctorDetails(doctor) {
            // تحديث الإحصائيات
            updateDoctorStats(doctor);
            
            // تحديث التفاصيل
            document.getElementById('doctor-name').textContent = doctor.doctorName || 'غير معروف';
            document.getElementById('doctor-id').textContent = doctor.doctorId || 'غير محدد';
            document.getElementById('doctor-specialty').textContent = doctor.specialty || 'غير محدد';
            document.getElementById('doctor-rep').textContent = doctor.rep || 'غير محدد';
            document.getElementById('doctor-address').textContent = doctor.address || 'غير محدد';
            document.getElementById('doctor-area').textContent = doctor.area || 'غير محدد';
            document.getElementById('doctor-phone').textContent = doctor.phone || 'غير محدد';
            
            // حساب أول حالة
            const firstCaseDate = getFirstCaseDateForDoctor(doctor.doctorId);
            document.getElementById('first-case-date').textContent = firstCaseDate || 'غير محدد';
            
            // إظهار الأقسام
            document.getElementById('doctor-stats-section').style.display = 'block';
            document.getElementById('doctor-details-section').style.display = 'block';
            document.getElementById('doctor-charts-section').style.display = 'block';
            
            // رسم الرسوم البيانية
            drawDoctorCharts(doctor.doctorId);
            
            // تحديث جدول الحالات الشهرية
            updateDoctorMonthlyTable(doctor.doctorId);
        }
        
        // تحديث إحصائيات الطبيب
        function updateDoctorStats(doctor) {
            const doctorId = doctor.doctorId;
            
            // حساب إجمالي الحالات
            const totalCases = calculateTotalCasesForDoctor(doctorId);
            document.getElementById('total-cases').textContent = totalCases;
            
            // حساب عدد أشهر النشاط
            const activeMonths = getActiveMonthsCountForDoctor(doctorId);
            document.getElementById('active-months').textContent = activeMonths;
            
            // حساب متوسط الحالات شهرياً
            const avgMonthlyCases = activeMonths > 0 ? Math.round(totalCases / activeMonths) : 0;
            document.getElementById('avg-monthly-cases').textContent = avgMonthlyCases;
            
            // حساب التقييم
            const rating = calculateDoctorRating(doctorId, totalCases, avgMonthlyCases);
            document.getElementById('performance-rating').textContent = rating;
        }
        
        // حساب عدد أشهر النشاط للطبيب
        function getActiveMonthsCountForDoctor(doctorId) {
            let months = new Set();
            
            for (let i = 0; i < doctorsData.length; i++) {
                if (doctorsData[i].doctorId == doctorId && doctorsData[i].cases > 0) {
                    const monthKey = `${doctorsData[i].year}-${String(doctorsData[i].month).padStart(2, '0')}`;
                    months.add(monthKey);
                }
            }
            
            return months.size;
        }
        
        // حساب تاريخ أول حالة للطبيب
        function getFirstCaseDateForDoctor(doctorId) {
            let firstDate = null;
            
            for (let i = 0; i < doctorsData.length; i++) {
                if (doctorsData[i].doctorId == doctorId && doctorsData[i].cases > 0) {
                    const month = doctorsData[i].month;
                    const year = doctorsData[i].year;
                    const dateStr = `${year}-${String(month).padStart(2, '0')}`;
                    
                    if (!firstDate || dateStr < firstDate) {
                        firstDate = dateStr;
                    }
                }
            }
            
            return firstDate ? formatDate(firstDate) : null;
        }
        
        // تنسيق التاريخ
        function formatDate(dateStr) {
            const [year, month] = dateStr.split('-');
            const monthNames = [
                'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
            ];
            const monthIndex = parseInt(month) - 1;
            return `${monthNames[monthIndex]} ${year}`;
        }
        
        // حساب تقييم الطبيب
        function calculateDoctorRating(doctorId, totalCases, avgMonthlyCases) {
            let rating = 0;
            
            // إجمالي الحالات (40% من التقييم)
            if (totalCases >= 100) rating += 4;
            else if (totalCases >= 50) rating += 3;
            else if (totalCases >= 20) rating += 2;
            else if (totalCases >= 5) rating += 1;
            
            // متوسط الحالات شهرياً (30% من التقييم)
            if (avgMonthlyCases >= 20) rating += 3;
            else if (avgMonthlyCases >= 10) rating += 2;
            else if (avgMonthlyCases >= 5) rating += 1;
            
            // عدد أشهر النشاط (30% من التقييم)
            const activeMonths = getActiveMonthsCountForDoctor(doctorId);
            if (activeMonths >= 6) rating += 3;
            else if (activeMonths >= 3) rating += 2;
            else if (activeMonths >= 1) rating += 1;
            
            // تحويل إلى مقياس 5 نجوم
            const starRating = (rating / 2).toFixed(1);
            return starRating;
        }
        
        // رسم الرسوم البيانية للطبيب
        function drawDoctorCharts(doctorId) {
            // تدمير الرسوم البيانية القديمة إن وجدت
            if (doctorChart1) doctorChart1.destroy();
            if (doctorChart2) doctorChart2.destroy();
            
            // الحصول على بيانات الحالات الشهرية
            const monthlyCases = getMonthlyCasesForDoctor(doctorId);
            const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                              'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            
            // تحويل البيانات إلى مصفوفة
            const casesData = [];
            for (let i = 1; i <= 12; i++) {
                casesData.push(monthlyCases[i] || 0);
            }
            
            // الرسم البياني 1: عدد الحالات لكل شهر (أعمدة)
            const ctx1 = document.getElementById('doctor-monthly-chart').getContext('2d');
            doctorChart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'عدد الحالات',
                        data: casesData,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'عدد الحالات لكل شهر',
                            font: {
                                size: 16,
                                weight: '900'
                            }
                        },
                        legend: {
                            labels: {
                                font: {
                                    weight: '900'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '900'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '900'
                                }
                            }
                        }
                    }
                }
            });
            
            // الرسم البياني 2: اتجاه الحالات خلال السنة (خط)
            const ctx2 = document.getElementById('doctor-trend-chart').getContext('2d');
            doctorChart2 = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'اتجاه الحالات',
                        data: casesData,
                        backgroundColor: 'rgba(46, 204, 113, 0.2)',
                        borderColor: '#27ae60',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'اتجاه الحالات خلال السنة',
                            font: {
                                size: 16,
                                weight: '900'
                            }
                        },
                        legend: {
                            labels: {
                                font: {
                                    weight: '900'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '900'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '900'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // تحديث جدول الحالات الشهرية للطبيب
        function updateDoctorMonthlyTable(doctorId) {
            const monthlyCases = getMonthlyCasesForDoctor(doctorId);
            const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                              'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            
            // حساب إجمالي الحالات
            let totalCases = 0;
            for (let i = 1; i <= 12; i++) {
                totalCases += monthlyCases[i] || 0;
            }
            
            // حساب المتوسط
            const avgCases = totalCases > 0 ? Math.round(totalCases / 12) : 0;
            
            let tableHTML = '';
            for (let i = 1; i <= 12; i++) {
                const cases = monthlyCases[i] || 0;
                const percentage = totalCases > 0 ? Math.round((cases / totalCases) * 100) : 0;
                const dailyAvg = cases > 0 ? (cases / 30).toFixed(1) : 0;
                const comparison = avgCases > 0 ? ((cases - avgCases) / avgCases * 100).toFixed(1) : 0;
                const comparisonClass = comparison > 0 ? 'text-success' : comparison < 0 ? 'text-danger' : '';
                const comparisonSymbol = comparison > 0 ? '+' : '';
                
                tableHTML += `
                    <tr>
                        <td>${monthNames[i-1]}</td>
                        <td><strong>${cases}</strong></td>
                        <td>${percentage}%</td>
                        <td>${dailyAvg}</td>
                        <td class="${comparisonClass}">${comparisonSymbol}${comparison}%</td>
                    </tr>
                `;
            }
            
            document.getElementById('doctor-monthly-table').innerHTML = tableHTML;
        }
        
        // طباعة تقرير الطبيب
        function printDoctorReport() {
            if (!currentDoctor) {
                alert('لم يتم اختيار أي طبيب. يرجى البحث عن طبيب أولاً.');
                return;
            }
            
            // إنشاء محتوى التقرير للطباعة
            const doctorId = currentDoctor.doctorId;
            const totalCases = calculateTotalCasesForDoctor(doctorId);
            const activeMonths = getActiveMonthsCountForDoctor(doctorId);
            const avgMonthlyCases = activeMonths > 0 ? Math.round(totalCases / activeMonths) : 0;
            const rating = calculateDoctorRating(doctorId, totalCases, avgMonthlyCases);
            const monthlyCases = getMonthlyCasesForDoctor(doctorId);
            const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                              'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            
            let reportContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير الطبيب - ${currentDoctor.doctorName || 'غير معروف'}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap');
                        
                        body {
                            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            direction: rtl;
                            padding: 20px;
                            color: #333;
                            font-size: 12px;
                            font-weight: 700;
                        }
                        
                        @page {
                            size: A4;
                            margin: 20mm;
                        }
                        
                        .report-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 3px solid #2C3E50;
                            padding-bottom: 20px;
                        }
                        
                        .report-header h1 {
                            color: #2C3E50;
                            font-size: 24px;
                            margin-bottom: 10px;
                        }
                        
                        .report-header h2 {
                            color: #3498DB;
                            font-size: 18px;
                        }
                        
                        .stats-container {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                            margin-bottom: 30px;
                        }
                        
                        .stat-item {
                            text-align: center;
                            padding: 15px;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            background: #f8f9fa;
                        }
                        
                        .stat-number {
                            font-size: 24px;
                            font-weight: 900;
                            color: #2C3E50;
                            margin-bottom: 5px;
                        }
                        
                        .stat-label {
                            font-size: 14px;
                            color: #7F8C8D;
                        }
                        
                        .doctor-info {
                            margin-bottom: 30px;
                        }
                        
                        .info-row {
                            display: flex;
                            margin-bottom: 10px;
                            padding-bottom: 10px;
                            border-bottom: 1px solid #eee;
                        }
                        
                        .info-label {
                            font-weight: 800;
                            color: #2C3E50;
                            min-width: 120px;
                        }
                        
                        .info-value {
                            flex: 1;
                            color: #333;
                        }
                        
                        .table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        
                        .table th {
                            background: #2C3E50;
                            color: white;
                            padding: 10px;
                            text-align: right;
                        }
                        
                        .table td {
                            padding: 8px 10px;
                            border: 1px solid #ddd;
                        }
                        
                        .table-striped tbody tr:nth-child(odd) {
                            background: #f8f9fa;
                        }
                        
                        .signature {
                            margin-top: 50px;
                            text-align: left;
                            border-top: 2px solid #E74C3C;
                            padding-top: 10px;
                            display: inline-block;
                        }
                        
                        @media print {
                            body {
                                font-size: 10px;
                            }
                            
                            .report-header h1 {
                                font-size: 20px;
                            }
                            
                            .report-header h2 {
                                font-size: 16px;
                            }
                            
                            .stat-number {
                                font-size: 18px;
                            }
                            
                            .table th, .table td {
                                padding: 5px 8px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>تقرير الطبيب المفصل</h1>
                        <h2>${currentDoctor.doctorName || 'غير معروف'}</h2>
                        <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>
                    
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-number">${totalCases}</div>
                            <div class="stat-label">إجمالي الحالات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${activeMonths}</div>
                            <div class="stat-label">أشهر النشاط</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${avgMonthlyCases}</div>
                            <div class="stat-label">متوسط الحالات شهرياً</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${rating}/5</div>
                            <div class="stat-label">التقييم</div>
                        </div>
                    </div>
                    
                    <div class="doctor-info">
                        <div class="info-row">
                            <span class="info-label">اسم الطبيب:</span>
                            <span class="info-value">${currentDoctor.doctorName || 'غير معروف'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">رقم الطبيب:</span>
                            <span class="info-value">${currentDoctor.doctorId || 'غير محدد'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">التخصص:</span>
                            <span class="info-value">${currentDoctor.specialty || 'غير محدد'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">المندوب:</span>
                            <span class="info-value">${currentDoctor.rep || 'غير محدد'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">العنوان:</span>
                            <span class="info-value">${currentDoctor.address || 'غير محدد'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">المنطقة:</span>
                            <span class="info-value">${currentDoctor.area || 'غير محدد'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">الهاتف:</span>
                            <span class="info-value">${currentDoctor.phone || 'غير محدد'}</span>
                        </div>
                    </div>
                    
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>الشهر</th>
                                <th>عدد الحالات</th>
                                <th>النسبة المئوية</th>
                                <th>المعدل اليومي</th>
                                <th>المقارنة مع المتوسط</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // إضافة صفوف الجدول
            for (let i = 1; i <= 12; i++) {
                const cases = monthlyCases[i] || 0;
                const percentage = totalCases > 0 ? Math.round((cases / totalCases) * 100) : 0;
                const dailyAvg = cases > 0 ? (cases / 30).toFixed(1) : 0;
                const comparison = avgMonthlyCases > 0 ? ((cases - avgMonthlyCases) / avgMonthlyCases * 100).toFixed(1) : 0;
                const comparisonSymbol = comparison > 0 ? '+' : '';
                
                reportContent += `
                    <tr>
                        <td>${monthNames[i-1]}</td>
                        <td><strong>${cases}</strong></td>
                        <td>${percentage}%</td>
                        <td>${dailyAvg}</td>
                        <td>${comparisonSymbol}${comparison}%</td>
                    </tr>
                `;
            }
            
            reportContent += `
                        </tbody>
                    </table>
                    
                    <div class="signature">
                        <strong>أخصائي العلاقات</strong><br>
                        سام جميل القدسي<br>
                        ${new Date().toLocaleDateString('ar-EG')}
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            // فتح نافذة جديدة للطباعة
            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write(reportContent);
            printWindow.document.close();
        }
        
        // إعداد مستمعي الأحدث للبحث - جديد
        function setupSearchEventListeners() {
            // البحث عند الضغط على Enter في حقل البحث
            document.getElementById('address-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchByAddress();
                }
            });
            
            // تحديث الفلاتر عند تغييرها
            document.getElementById('address-filter-rep').addEventListener('change', applyAddressFilters);
            document.getElementById('address-filter-area').addEventListener('change', applyAddressFilters);
            document.getElementById('address-filter-specialty').addEventListener('change', applyAddressFilters);
        }
        
        // البحث المحسّن بالعنوان - سريع جداً لكل شهر على حدة
        function searchByAddress() {
            const searchValue = document.getElementById('address-search').value.trim();
            
            if (!searchValue) {
                alert('يرجى إدخال نص للبحث في العنوان');
                return;
            }
            
            if (Object.keys(doctorsMonthlyData).length === 0) {
                alert('لم يتم تحميل بيانات الأطباء بعد. يرجى رفع ومعالجة ملفات الأطباء أولاً.');
                return;
            }
            
            // التحقق من ذاكرة التخزين المؤقت
            const cacheKey = searchValue.toLowerCase();
            if (addressSearchCache[cacheKey] && addressSearchCache[cacheKey].timestamp > Date.now() - 300000) {
                const cachedResults = addressSearchCache[cacheKey].results;
                displayAddressSearchResults(cachedResults, 0, searchValue);
                return;
            }
            
            // إظهار نافذة التحميل
            document.getElementById('loading-overlay').classList.add('active');
            
            // مسح نتائج البحث السابقة
            addressSearchResults = [];
            allSearchDoctors = [];
            filteredSearchDoctors = [];
            
            // البحث في كل شهر على حدة
            const searchLower = searchValue.toLowerCase();
            const startTime = performance.now();
            
            // إنشاء Map لتجميع النتائج
            const resultsMap = new Map();
            const doctorIdSet = new Set();
            const searchMonths = [];
            
            // البحث في كل شهر
            for (const monthKey in doctorsMonthlyData) {
                if (!doctorsMonthlyData[monthKey] || !doctorsMonthlyData[monthKey].data) continue;
                
                const monthData = doctorsMonthlyData[monthKey].data;
                const monthStartTime = performance.now();
                let monthFound = false;
                
                // بناء الفهرس لهذا الشهر إذا لم يكن موجوداً
                if (!fastAddressIndexByMonth.has(monthKey)) {
                    buildFastAddressIndexForMonth(monthKey);
                }
                
                // البحث باستخدام الفهرس السريع لهذا الشهر
                const addressIndex = fastAddressIndexByMonth.get(monthKey);
                if (addressIndex) {
                    for (const [addressKey, doctors] of addressIndex.entries()) {
                        if (addressKey.includes(searchLower)) {
                            monthFound = true;
                            
                            if (!resultsMap.has(addressKey)) {
                                resultsMap.set(addressKey, {
                                    address: doctors[0].address || 'غير محدد',
                                    doctors: [],
                                    months: new Set()
                                });
                            }
                            
                            // تجنب تكرار الأطباء في نفس العنوان
                            const existingIds = new Set(resultsMap.get(addressKey).doctors.map(d => d.doctorId));
                            for (const doctor of doctors) {
                                if (!existingIds.has(doctor.doctorId)) {
                                    const doctorWithMonth = {
                                        ...doctor,
                                        monthKey: monthKey,
                                        monthName: getMonthNameFromKey(monthKey)
                                    };
                                    resultsMap.get(addressKey).doctors.push(doctorWithMonth);
                                    resultsMap.get(addressKey).months.add(monthKey);
                                }
                            }
                        }
                    }
                }
                
                // إذا لم توجد نتائج في الفهرس، البحث المباشر في بيانات الشهر
                if (!monthFound) {
                    const searchWords = searchLower.split(/\s+/).filter(word => word.length > 1);
                    
                    for (let i = 0; i < monthData.length; i++) {
                        const doctor = monthData[i];
                        if (!doctor.address) continue;
                        
                        const doctorAddress = doctor.address.toLowerCase();
                        let matches = false;
                        
                        if (searchWords.length > 0) {
                            matches = searchWords.every(word => doctorAddress.includes(word));
                        } else {
                            matches = doctorAddress.includes(searchLower);
                        }
                        
                        if (matches) {
                            monthFound = true;
                            const addressKey = doctorAddress.trim();
                            if (!resultsMap.has(addressKey)) {
                                resultsMap.set(addressKey, {
                                    address: doctor.address,
                                    doctors: [],
                                    months: new Set()
                                });
                            }
                            
                            const existingIds = new Set(resultsMap.get(addressKey).doctors.map(d => d.doctorId));
                            if (!existingIds.has(doctor.doctorId)) {
                                const doctorWithMonth = {
                                    ...doctor,
                                    monthKey: monthKey,
                                    monthName: getMonthNameFromKey(monthKey)
                                };
                                resultsMap.get(addressKey).doctors.push(doctorWithMonth);
                                resultsMap.get(addressKey).months.add(monthKey);
                            }
                        }
                    }
                }
                
                if (monthFound) {
                    searchMonths.push({
                        month: monthKey,
                        time: performance.now() - monthStartTime
                    });
                }
            }
            
            // تحويل الـ Map إلى مصفوفة للعرض
            const results = [];
            for (const [addressKey, data] of resultsMap.entries()) {
                results.push({
                    address: data.address,
                    doctors: data.doctors,
                    months: Array.from(data.months),
                    matchScore: 100,
                    matchType: 'مطابقة كاملة'
                });
                
                // جمع جميع الأطباء من النتائج
                for (const doctor of data.doctors) {
                    if (!doctorIdSet.has(doctor.doctorId)) {
                        doctorIdSet.add(doctor.doctorId);
                        allSearchDoctors.push(doctor);
                    }
                }
            }
            
            // حساب وقت البحث
            const endTime = performance.now();
            const searchTime = endTime - startTime;
            
            // حفظ النتائج في المتغير العام
            addressSearchResults = results;
            filteredSearchDoctors = [...allSearchDoctors];
            
            // تخزين في ذاكرة التخزين المؤقت
            addressSearchCache[cacheKey] = {
                results: results,
                timestamp: Date.now()
            };
            
            // تنظيف الذاكرة المؤقتة
            storageManager.cleanupOldData();
            
            // عرض النتائج
            displayAddressSearchResults(results, searchTime, searchValue);
            
            // عرض معلومات أداء البحث
            displaySearchPerformanceInfo(searchMonths, searchTime);
            
            // إظهار الفلاتر
            document.getElementById('address-filters').style.display = 'block';
            
            // تحديث الفلاتر
            updateAddressFilters();
            
            // تطبيق الفلاتر الحالية
            applyAddressFilters();
            
            // إخفاء نافذة التحميل
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.remove('active');
            }, 500);
        }
        
        // عرض معلومات أداء البحث
        function displaySearchPerformanceInfo(searchMonths, totalTime) {
            const perfInfo = document.getElementById('search-perf-info');
            let html = `<strong>أداء البحث:</strong> ${totalTime.toFixed(2)}ms<br>`;
            html += `<strong>الشهور المفحوصة:</strong> ${searchMonths.length}<br>`;
            html += `<div class="mt-2">`;
            
            for (const month of searchMonths) {
                html += `<span class="month-search-status found">${getMonthNameFromKey(month.month)} (${month.time.toFixed(0)}ms)</span>`;
            }
            
            // الشهور التي لم تحتوي على نتائج
            const totalMonths = Object.keys(doctorsMonthlyData).length;
            if (searchMonths.length < totalMonths) {
                html += `<span class="month-search-status not-found">+${totalMonths - searchMonths.length} شهر بلا نتائج</span>`;
            }
            
            html += `</div>`;
            perfInfo.innerHTML = html;
            perfInfo.style.display = 'block';
        }
        
        // بناء فهرس سريع للعناوين لشهر معين
        function buildFastAddressIndexForMonth(monthKey) {
            const monthData = doctorsMonthlyData[monthKey]?.data;
            if (!monthData) return;
            
            const addressIndex = new Map();
            
            for (let i = 0; i < monthData.length; i++) {
                const doctor = monthData[i];
                if (!doctor.address) continue;
                
                const addressKey = doctor.address.toLowerCase().trim();
                if (!addressIndex.has(addressKey)) {
                    addressIndex.set(addressKey, []);
                }
                
                // إضافة معلومات الشهر للطبيب
                const doctorWithMonth = {
                    ...doctor,
                    monthKey: monthKey,
                    monthName: getMonthNameFromKey(monthKey)
                };
                addressIndex.get(addressKey).push(doctorWithMonth);
            }
            
            fastAddressIndexByMonth.set(monthKey, addressIndex);
        }
        
        // الحصول على اسم الشهر من المفتاح
        function getMonthNameFromKey(monthKey) {
            const [year, month] = monthKey.split('-');
            const monthNames = [
                'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
            ];
            const monthIndex = parseInt(month) - 1;
            return monthNames[monthIndex] + ' ' + year;
        }
        
        // تحديث قوائم الفلاتر للبحث بالعنوان
        function updateAddressFilters() {
            if (allSearchDoctors.length === 0) return;
            
            // تحديث فلتر المندوبين
            const repFilter = document.getElementById('address-filter-rep');
            const currentRep = repFilter.value;
            
            repFilter.innerHTML = '<option value="all">جميع المندوبين</option>';
            const uniqueReps = [...new Set(allSearchDoctors.map(d => d.rep).filter(rep => rep && rep.trim() !== ''))];
            uniqueReps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep;
                option.textContent = rep;
                repFilter.appendChild(option);
            });
            
            if (currentRep && uniqueReps.includes(currentRep)) {
                repFilter.value = currentRep;
            }
            
            // تحديث فلتر المناطق
            const areaFilter = document.getElementById('address-filter-area');
            const currentArea = areaFilter.value;
            
            areaFilter.innerHTML = '<option value="all">جميع المناطق</option>';
            const uniqueAreas = [...new Set(allSearchDoctors.map(d => d.area).filter(area => area && area.trim() !== ''))];
            uniqueAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });
            
            if (currentArea && uniqueAreas.includes(currentArea)) {
                areaFilter.value = currentArea;
            }
            
            // تحديث فلتر التخصصات
            const specialtyFilter = document.getElementById('address-filter-specialty');
            const currentSpecialty = specialtyFilter.value;
            
            specialtyFilter.innerHTML = '<option value="all">جميع التخصصات</option>';
            
            // جمع التخصصات من بيانات الأطباء في نتائج البحث
            const specialtySet = new Set();
            for (let i = 0; i < allSearchDoctors.length; i++) {
                const doctor = allSearchDoctors[i];
                if (doctor.specialty && doctor.specialty.trim() !== '') {
                    specialtySet.add(doctor.specialty);
                }
            }
            
            // تحويل Set إلى مصفوفة وفرزها
            const uniqueSpecialties = Array.from(specialtySet).sort();
            uniqueSpecialties.forEach(specialty => {
                const option = document.createElement('option');
                option.value = specialty;
                option.textContent = specialty;
                specialtyFilter.appendChild(option);
            });
            
            if (currentSpecialty && uniqueSpecialties.includes(currentSpecialty)) {
                specialtyFilter.value = currentSpecialty;
            }
        }
        
        // تطبيق الفلاتر على نتائج البحث
        function applyAddressFilters() {
            if (allSearchDoctors.length === 0) return;
            
            const repFilter = document.getElementById('address-filter-rep').value;
            const areaFilter = document.getElementById('address-filter-area').value;
            const specialtyFilter = document.getElementById('address-filter-specialty').value;
            
            filteredSearchDoctors = allSearchDoctors.filter(doctor => {
                // فلتر المندوب
                if (repFilter !== 'all') {
                    if (!doctor.rep || doctor.rep !== repFilter) return false;
                }
                
                // فلتر المنطقة
                if (areaFilter !== 'all') {
                    if (!doctor.area || doctor.area !== areaFilter) return false;
                }
                
                // فلتر التخصص
                if (specialtyFilter !== 'all') {
                    if (!doctor.specialty || doctor.specialty !== specialtyFilter) return false;
                }
                
                return true;
            });
            
            // تحديث عرض النتائج
            updateAddressSearchResultsDisplay();
            
            // تحديث زر اختيار جميع النتائج
            const selectAllBtn = document.getElementById('select-all-results-btn');
            if (filteredSearchDoctors.length > 0) {
                selectAllBtn.style.display = 'block';
                selectAllBtn.innerHTML = `<i class="fas fa-users me-1"></i> اختيار جميع الأطباء في نتائج البحث (${filteredSearchDoctors.length} طبيب)`;
            } else {
                selectAllBtn.style.display = 'none';
            }
        }
        
        // تحديث عرض نتائج البحث بعد التصفية
        function updateAddressSearchResultsDisplay() {
            if (filteredSearchDoctors.length === 0) {
                const resultsContainer = document.getElementById('address-search-results');
                resultsContainer.innerHTML = `
                    <div class="address-search-item text-center text-muted p-5">
                        <i class="fas fa-filter fa-lg mb-3"></i>
                        <h5>لا توجد نتائج بعد التصفية</h5>
                        <p>جرب تغيير إعدادات الفلاتر</p>
                    </div>
                `;
                return;
            }
            
            // عرض النتائج المصفاة
            const resultsContainer = document.getElementById('address-search-results');
            let resultsHTML = `
                <div class="search-meta">
                    <i class="fas fa-filter me-1"></i>
                    عرض ${filteredSearchDoctors.length} نتيجة بعد التصفية
                </div>
            `;
            
            // تجميع الأطباء حسب العنوان
            const doctorsByAddress = {};
            filteredSearchDoctors.forEach(doctor => {
                const address = doctor.address || 'غير محدد';
                if (!doctorsByAddress[address]) {
                    doctorsByAddress[address] = [];
                }
                doctorsByAddress[address].push(doctor);
            });
            
            // عرض النتائج
            Object.keys(doctorsByAddress).forEach(address => {
                const doctors = doctorsByAddress[address];
                
                resultsHTML += `
                    <div class="address-search-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">${address}</h6>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-user-md me-1"></i>${doctors.length} طبيب
                                    </small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="selectAllDoctorsForAddress('${address.replace(/'/g, "\\'")}')">
                                <i class="fas fa-users me-1"></i> اختيار الكل
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            ${doctors.slice(0, 3).map(doctor => `
                                <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                                    <div>
                                        <strong>${doctor.doctorName || 'غير معروف'}</strong>
                                        <div class="text-muted small">
                                            <span>رقم: ${doctor.doctorId || 'غير محدد'}</span> | 
                                            <span>تخصص: ${doctor.specialty || 'غير محدد'}</span> |
                                            <span>منطقة: ${doctor.area || 'غير محدد'}</span> |
                                            <span>شهر: ${doctor.monthName || 'غير محدد'}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="selectDoctorFromAddressSearch('${doctor.doctorId}')">
                                            <i class="fas fa-plus"></i> إضافة
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${doctors.length > 3 ? `
                                <div class="text-center mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showAllDoctorsForAddress('${address.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-chevron-down me-1"></i>
                                        عرض ${doctors.length - 3} طبيب إضافي
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;
        }
        
        // عرض نتائج البحث بالعنوان مع الإحصائيات - محسّن
        function displayAddressSearchResults(results, searchTime, searchQuery) {
            const resultsContainer = document.getElementById('address-search-results');
            const statsContainer = document.getElementById('address-search-stats');
            
            // عرض إحصائيات البحث
            if (statsContainer) {
                const totalDoctors = allSearchDoctors.length;
                const totalAddresses = results.length;
                
                statsContainer.innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <i class="fas fa-search me-1"></i>
                            <strong>كلمة البحث:</strong> "${searchQuery}"
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <strong>عدد العناوين:</strong> ${totalAddresses}
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-user-md me-1"></i>
                            <strong>عدد الأطباء:</strong> ${totalDoctors}
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-clock me-1"></i>
                            <strong>وقت البحث:</strong> <span class="search-time">${searchTime.toFixed(2)}ms</span>
                        </div>
                    </div>
                `;
                statsContainer.style.display = 'block';
            }
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="address-search-item text-center text-muted p-5">
                        <i class="fas fa-search fa-lg mb-3"></i>
                        <h5>لم يتم العثور على نتائج</h5>
                        <p>لم يتم العثور على عناوين تحتوي على "${searchQuery}"</p>
                        <small class="text-muted">جرب استخدام كلمات بحث مختلفة</small>
                    </div>
                `;
                resultsContainer.style.display = 'block';
                document.getElementById('address-filters').style.display = 'none';
                return;
            }
            
            // عرض النتائج
            let resultsHTML = `
                <div class="search-meta">
                    <i class="fas fa-info-circle me-1"></i>
                    عرض ${results.length} نتيجة مرتبة حسب العنوان
                </div>
            `;
            
            for (let i = 0; i < results.length; i++) {
                const result = results[i];
                
                resultsHTML += `
                    <div class="address-search-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">${result.address}</h6>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-user-md me-1"></i>${result.doctors.length} طبيب
                                        <i class="fas fa-calendar-alt me-1 ms-2"></i>${result.months.length} شهر
                                    </small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="selectAllDoctorsForAddress('${result.address.replace(/'/g, "\\'")}')">
                                <i class="fas fa-users me-1"></i> اختيار الكل
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            ${result.doctors.slice(0, 3).map(doctor => `
                                <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                                    <div>
                                        <strong>${doctor.doctorName || 'غير معروف'}</strong>
                                        <div class="text-muted small">
                                            <span>رقم: ${doctor.doctorId || 'غير محدد'}</span> | 
                                            <span>تخصص: ${doctor.specialty || 'غير محدد'}</span> |
                                            <span>شهر: ${doctor.monthName || 'غير محدد'}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="selectDoctorFromAddressSearch('${doctor.doctorId}')">
                                            <i class="fas fa-plus"></i> إضافة
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${result.doctors.length > 3 ? `
                                <div class="text-center mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showAllDoctorsForAddress('${result.address.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-chevron-down me-1"></i>
                                        عرض ${result.doctors.length - 3} طبيب إضافي
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.style.display = 'block';
        }
        
        // اختيار جميع الأطباء في نتائج البحث الحالية
        function selectAllDoctorsFromAddressSearch() {
            if (filteredSearchDoctors.length === 0) {
                alert('لا توجد أطباء في نتائج البحث الحالية');
                return;
            }
            
            let addedCount = 0;
            const existingIds = new Set(addressSelectedDoctors.map(d => d.doctorId));
            
            for (let i = 0; i < filteredSearchDoctors.length; i++) {
                const doctor = filteredSearchDoctors[i];
                if (!existingIds.has(doctor.doctorId)) {
                    addressSelectedDoctors.push({
                        doctorId: doctor.doctorId,
                        doctorName: doctor.doctorName,
                        specialty: doctor.specialty || 'غير محدد',
                        address: doctor.address || 'غير محدد',
                        phone: doctor.phone || 'غير محدد',
                        rep: doctor.rep || 'غير محدد',
                        area: doctor.area || 'غير محدد',
                        monthKey: doctor.monthKey,
                        monthName: doctor.monthName
                    });
                    addedCount++;
                }
            }
            
            // تحديث عرض الأطباء المحددين
            updateAddressSelectedDoctorsDisplay();
            
            alert(`تم إضافة ${addedCount} طبيب من نتائج البحث الحالية`);
        }
        
        // عرض جميع الأطباء للعنوان
        function showAllDoctorsForAddress(address) {
            // البحث عن الأطباء في العنوان المحدد
            const doctorsInAddress = allSearchDoctors.filter(doctor => doctor.address === address);
            
            if (doctorsInAddress.length === 0) return;
            
            // إنشاء نافذة منبثقة لعرض جميع الأطباء
            const modalHTML = `
                <div class="modal fade" id="allDoctorsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">جميع الأطباء في العنوان: ${address}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>اسم الطبيب</th>
                                                <th>رقم الطبيب</th>
                                                <th>التخصص</th>
                                                <th>المنطقة</th>
                                                <th>المندوب</th>
                                                <th>الشهر</th>
                                                <th>الهاتف</th>
                                                <th>الإجراء</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${doctorsInAddress.map(doctor => `
                                                <tr>
                                                    <td>${doctor.doctorName || 'غير معروف'}</td>
                                                    <td>${doctor.doctorId || 'غير محدد'}</td>
                                                    <td>${doctor.specialty || 'غير محدد'}</td>
                                                    <td>${doctor.area || 'غير محدد'}</td>
                                                    <td>${doctor.rep || 'غير محدد'}</td>
                                                    <td>${doctor.monthName || 'غير محدد'}</td>
                                                    <td>${doctor.phone || 'غير محدد'}</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary" onclick="selectDoctorFromAddressSearch('${doctor.doctorId}')">
                                                            <i class="fas fa-plus"></i> إضافة
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                                <button type="button" class="btn btn-primary" onclick="selectAllDoctorsForAddress('${address.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-users me-1"></i> اختيار جميع الأطباء
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // إضافة النافذة المنبثقة إلى DOM
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer.firstElementChild);
            
            // عرض النافذة المنبثقة
            const modal = new bootstrap.Modal(document.getElementById('allDoctorsModal'));
            modal.show();
            
            // تنظيف DOM بعد إغلاق النافذة
            document.getElementById('allDoctorsModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
        
        // اختيار جميع الأطباء لعنوان معين
        function selectAllDoctorsForAddress(address) {
            const doctorsInAddress = allSearchDoctors.filter(doctor => doctor.address === address);
            
            if (doctorsInAddress.length === 0) return;
            
            let addedCount = 0;
            const existingIds = new Set(addressSelectedDoctors.map(d => d.doctorId));
            
            for (let i = 0; i < doctorsInAddress.length; i++) {
                const doctor = doctorsInAddress[i];
                if (!existingIds.has(doctor.doctorId)) {
                    addressSelectedDoctors.push({
                        doctorId: doctor.doctorId,
                        doctorName: doctor.doctorName,
                        specialty: doctor.specialty || 'غير محدد',
                        address: doctor.address || 'غير محدد',
                        phone: doctor.phone || 'غير محدد',
                        rep: doctor.rep || 'غير محدد',
                        area: doctor.area || 'غير محدد',
                        monthKey: doctor.monthKey,
                        monthName: doctor.monthName
                    });
                    addedCount++;
                }
            }
            
            // تحديث عرض الأطباء المحددين
            updateAddressSelectedDoctorsDisplay();
            
            alert(`تم إضافة ${addedCount} طبيب من العنوان: ${address}`);
        }
        
        // اختيار طبيب من نتائج البحث بالعنوان
        function selectDoctorFromAddressSearch(doctorId) {
            // البحث عن الطبيب في نتائج البحث
            let doctor = null;
            
            // البحث في filteredSearchDoctors أولاً (الأطباء المصفاة)
            for (let i = 0; i < filteredSearchDoctors.length; i++) {
                if (filteredSearchDoctors[i].doctorId == doctorId) {
                    doctor = filteredSearchDoctors[i];
                    break;
                }
            }
            
            if (!doctor) {
                // البحث في allSearchDoctors
                for (let i = 0; i < allSearchDoctors.length; i++) {
                    if (allSearchDoctors[i].doctorId == doctorId) {
                        doctor = allSearchDoctors[i];
                        break;
                    }
                }
            }
            
            if (!doctor) {
                // البحث في البيانات الكاملة
                for (let i = 0; i < doctorsData.length; i++) {
                    if (doctorsData[i].doctorId == doctorId) {
                        doctor = doctorsData[i];
                        break;
                    }
                }
            }
            
            if (!doctor) {
                alert('لم يتم العثور على بيانات الطبيب');
                return;
            }
            
            // التحقق من عدم اختيار الطبيب مسبقاً
            for (let i = 0; i < addressSelectedDoctors.length; i++) {
                if (addressSelectedDoctors[i].doctorId === doctorId) {
                    alert('تم اختيار هذا الطبيب مسبقاً');
                    return;
                }
            }
            
            // إضافة الطبيب إلى القائمة المحددة
            addressSelectedDoctors.push({
                doctorId: doctor.doctorId,
                doctorName: doctor.doctorName,
                specialty: doctor.specialty || 'غير محدد',
                address: doctor.address || 'غير محدد',
                phone: doctor.phone || 'غير محدد',
                rep: doctor.rep || 'غير محدد',
                area: doctor.area || 'غير محدد',
                monthKey: doctor.monthKey,
                monthName: doctor.monthName || getMonthNameFromKey(doctor.monthKey)
            });
            
            // تحديث عرض الأطباء المحددين
            updateAddressSelectedDoctorsDisplay();
        }
        
        // تحديث عرض الأطباء المحددين للبحث بالعنوان
        function updateAddressSelectedDoctorsDisplay() {
            const container = document.getElementById('address-selected-doctors');
            
            if (addressSelectedDoctors.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-3 border rounded">
                        <i class="fas fa-user-md fa-lg mb-2"></i>
                        <p>لم يتم اختيار أي أطباء بعد</p>
                        <small class="text-muted">ابحث عن الأطباء وأضفهم من القائمة أعلاه</small>
                    </div>
                `;
                return;
            }
            
            // تجميع الأطباء حسب العنوان مع تجنب التكرار
            const groupedByAddress = {};
            const seenDoctors = new Set();
            
            for (let i = 0; i < addressSelectedDoctors.length; i++) {
                const doctor = addressSelectedDoctors[i];
                if (seenDoctors.has(doctor.doctorId)) {
                    continue; // تخطي الطبيب المكرر
                }
                seenDoctors.add(doctor.doctorId);
                
                const address = doctor.address;
                if (!groupedByAddress[address]) {
                    groupedByAddress[address] = [];
                }
                groupedByAddress[address].push(doctor);
            }
            
            let displayHTML = `
                <div class="mb-2">
                    <strong>الأطباء المحددون (${seenDoctors.size}):</strong>
                </div>
            `;
            
            const addressKeys = Object.keys(groupedByAddress);
            for (let i = 0; i < addressKeys.length; i++) {
                const address = addressKeys[i];
                const doctors = groupedByAddress[address];
                
                displayHTML += `
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <strong>${address}</strong>
                            <small class="text-muted">(${doctors.length} طبيب)</small>
                        </div>
                        <div class="card-body p-2">
                            <div class="d-flex flex-wrap">
                                ${doctors.map(doctor => `
                                    <div class="selected-doctor-badge">
                                        <span class="remove-doctor" onclick="removeSelectedDoctorFromAddressReport('${doctor.doctorId}')">
                                            <i class="fas fa-times"></i>
                                        </span>
                                        ${doctor.doctorName} (${doctor.doctorId})
                                        <small class="text-muted ms-1">${doctor.rep || ''}</small>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                </div>
                `;
            }
            
            container.innerHTML = displayHTML;
        }
        
        // إزالة طبيب من قائمة العنوان المحددين
        function removeSelectedDoctorFromAddressReport(doctorId) {
            addressSelectedDoctors = addressSelectedDoctors.filter(d => d.doctorId !== doctorId);
            updateAddressSelectedDoctorsDisplay();
        }
        
        // مسح جميع الأطباء المحددين للبحث بالعنوان
        function clearSelectedDoctorsForAddressReport() {
            if (addressSelectedDoctors.length === 0) {
                alert('لا توجد أطباء محددة');
                return;
            }
            
            if (confirm(`هل أنت متأكد من مسح جميع الأطباء المحددين (${addressSelectedDoctors.length} طبيب)؟`)) {
                addressSelectedDoctors = [];
                updateAddressSelectedDoctorsDisplay();
                alert('تم مسح جميع الأطباء المحددين');
            }
        }
        
        // إنشاء شبكة الشهور (12 شهر)
        function createMonthGrid() {
            const monthGrid = document.getElementById('doctors-month-grid');
            monthGrid.innerHTML = '';
            
            const monthNames = [
                'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
            ];
            
            const currentYear = document.getElementById('doctors-year').value;
            
            // إنشاء شبكة 4x3 للشهور
            monthGrid.style.display = 'grid';
            monthGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
            monthGrid.style.gap = '15px';
            monthGrid.style.marginTop = '20px';
            
            for (let i = 0; i < monthNames.length; i++) {
                const monthName = monthNames[i];
                const monthNumber = i + 1;
                const monthKey = `${currentYear}-${monthNumber.toString().padStart(2, '0')}`;
                const monthData = doctorsMonthlyData[monthKey];
                const hasData = monthData ? true : false;
                const recordCount = hasData ? monthData.recordCount || monthData.data?.length || 0 : 0;
                const fileName = hasData ? (monthData.fileName || 'تم الرفع') : '';
                
                const monthCard = document.createElement('div');
                monthCard.className = `month-card ${hasData ? 'uploaded' : ''}`;
                monthCard.setAttribute('data-month', monthNumber);
                monthCard.setAttribute('data-year', currentYear);
                monthCard.setAttribute('data-key', monthKey);
                
                monthCard.innerHTML = `
                    <i class="fas ${hasData ? 'fa-check-circle' : 'fa-upload'}"></i>
                    <h6 style="margin: 10px 0; font-size: 1.1rem;">${monthName}</h6>
                    <div class="file-info" style="font-size: 0.9rem; color: ${hasData ? 'var(--success-color)' : 'var(--gray-dark)'};">
                        ${hasData ? `${recordCount} سجل` : 'انقر للرفع'}
                    </div>
                    ${hasData ? `<div class="file-name" style="font-size: 0.8rem; margin-top: 5px; color: var(--gray-dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fileName}</div>` : ''}
                    <input type="file" class="d-none month-file-input" accept=".xlsx, .xls" data-month="${monthNumber}" autocomplete="off">
                `;
                
                monthCard.addEventListener('click', function(e) {
                    // منع النقر إذا كان هناك أيقونة الحذف
                    if (e.target.classList.contains('delete-month')) return;
                    
                    const fileInput = this.querySelector('.month-file-input');
                    fileInput.click();
                });
                
                // إضافة زر حذف إذا كان هناك بيانات
                if (hasData) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-outline-danger delete-month';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '5px';
                    deleteBtn.style.left = '5px';
                    deleteBtn.style.padding = '2px 6px';
                    deleteBtn.style.fontSize = '0.7rem';
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteMonthData(monthKey, monthCard);
                    });
                    monthCard.appendChild(deleteBtn);
                }
                
                monthGrid.appendChild(monthCard);
            }
            
            // إضافة مستمعي الأحداث لمربعات الشهور
            setupMonthCardsEventListeners();
        }
        
        // حذف بيانات شهر معين
        function deleteMonthData(monthKey, monthCard) {
            if (!confirm(`هل أنت متأكد من حذف بيانات ${getMonthNameFromKey(monthKey)}؟`)) {
                return;
            }
            
            // حذف البيانات من الذاكرة
            delete doctorsMonthlyData[monthKey];
            fastAddressIndexByMonth.delete(monthKey);
            
            // حذف من localStorage باستخدام مدير التخزين
            storageManager.saveData('doctorsMonthlyData', doctorsMonthlyData);
            
            // تحديث الأطباء بعد الحذف
            updateAllDoctorsData();
            
            // تحديث الواجهة
            createMonthGrid();
            
            alert(`تم حذف بيانات ${getMonthNameFromKey(monthKey)} بنجاح`);
        }
        
        // إعداد مستمعي الأحداث لمربعات الشهور
        function setupMonthCardsEventListeners() {
            const monthFileInputs = document.querySelectorAll('.month-file-input');
            
            for (let i = 0; i < monthFileInputs.length; i++) {
                const input = monthFileInputs[i];
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const monthCard = this.closest('.month-card');
                    const month = parseInt(monthCard.getAttribute('data-month'));
                    const year = parseInt(monthCard.getAttribute('data-year'));
                    const monthKey = monthCard.getAttribute('data-key');
                    
                    // تحديث حالة الشهر
                    monthCard.classList.remove('uploaded');
                    monthCard.classList.add('uploading');
                    monthCard.querySelector('i').className = 'fas fa-spinner fa-spin';
                    monthCard.querySelector('.file-info').textContent = 'جاري الرفع...';
                    
                    // معالجة ملف الشهر
                    processDoctorMonthFile(file, month, year, monthCard);
                });
            }
        }
        
        // معالجة ملف شهر للأطباء (محسنة لاستخدام ذاكرة أقل)
        function processDoctorMonthFile(file, month, year, monthCard) {
            const reader = new FileReader();
            const startTime = Date.now();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                    const newDoctorsData = [];
                    
                    // تجنب تكرار الأطباء في نفس الشهر
                    const seenDoctors = new Set();
                    
                    // معالجة البيانات بدءاً من الصف الثاني
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        // محاولة تخطيط الحقول بشكل مرن
                        // الفرضية: الملف يحتوي على الحقول التالية (قد تكون مرتبة بشكل مختلف)
                        let rep = '', area = '', address = '', phone = '', cases = 0, doctorName = '', doctorId = '';
                        
                        // محاولة مطابقة الحقول بناءً على مواضعها
                        if (row.length >= 1) rep = String(row[0] || '').trim();
                        if (row.length >= 2) area = String(row[1] || '').trim();
                        if (row.length >= 3) address = String(row[2] || '').trim();
                        if (row.length >= 4) phone = String(row[3] || '').trim();
                        if (row.length >= 5) {
                            const casesValue = row[4];
                            if (typeof casesValue === 'number') {
                                cases = casesValue;
                            } else if (casesValue) {
                                cases = parseInt(casesValue) || 0;
                            }
                        }
                        if (row.length >= 6) doctorName = String(row[5] || '').trim();
                        if (row.length >= 7) doctorId = String(row[6] || '').trim();
                        
                        // إذا كان doctorId فارغاً، حاول إنشاء واحد من doctorName
                        if (!doctorId && doctorName) {
                            doctorId = `DR-${month}-${i}-${Math.random().toString(36).substr(2, 5)}`;
                        }
                        
                        // إذا كان لدينا بيانات كافية، أضف الطبيب مع تقليل حجم البيانات
                        if (doctorName || doctorId || address) {
                            const doctor = {
                                rep: rep,
                                area: area,
                                address: address,
                                phone: phone,
                                cases: cases,
                                doctorName: doctorName,
                                doctorId: doctorId || `DR-${month}-${i}`,
                                month: month,
                                year: year,
                                fileName: file.name,
                                fileId: generateFileId(),
                                monthKey: monthKey
                            };
                            
                            // تجنب تكرار الأطباء في نفس الشهر
                            const doctorKey = `${doctor.doctorId}_${monthKey}`;
                            if (!seenDoctors.has(doctorKey)) {
                                seenDoctors.add(doctorKey);
                                newDoctorsData.push(doctor);
                            }
                        }
                    }
                    
                    console.log(`تم استخراج ${newDoctorsData.length} طبيب من ملف ${file.name}`);
                    
                    // حفظ بيانات الشهر مع تحسين حجم البيانات
                    doctorsMonthlyData[monthKey] = {
                        data: newDoctorsData,
                        fileName: file.name,
                        fileSize: file.size,
                        uploadDate: new Date().toISOString(),
                        recordCount: newDoctorsData.length
                    };
                    
                    // حفظ في localStorage باستخدام مدير التخزين
                    const saveSuccess = storageManager.saveData('doctorsMonthlyData', doctorsMonthlyData);
                    
                    if (!saveSuccess) {
                        throw new Error('فشل في حفظ البيانات بسبب نقص المساحة التخزينية');
                    }
                    
                    // بناء الفهرس لهذا الشهر
                    buildFastAddressIndexForMonth(monthKey);
                    
                    // تحديث حالة الشهر
                    monthCard.classList.remove('uploading');
                    monthCard.classList.add('uploaded');
                    monthCard.querySelector('i').className = 'fas fa-check-circle';
                    monthCard.querySelector('.file-info').textContent = `${newDoctorsData.length} سجل`;
                    monthCard.querySelector('.file-info').style.color = 'var(--success-color)';
                    
                    // إضافة اسم الملف
                    let fileNameElement = monthCard.querySelector('.file-name');
                    if (!fileNameElement) {
                        fileNameElement = document.createElement('div');
                        fileNameElement.className = 'file-name';
                        fileNameElement.style.fontSize = '0.8rem';
                        fileNameElement.style.marginTop = '5px';
                        fileNameElement.style.color = 'var(--gray-dark)';
                        fileNameElement.style.overflow = 'hidden';
                        fileNameElement.style.textOverflow = 'ellipsis';
                        fileNameElement.style.whiteSpace = 'nowrap';
                        monthCard.appendChild(fileNameElement);
                    }
                    fileNameElement.textContent = file.name;
                    
                    // إضافة زر الحذف
                    let deleteBtn = monthCard.querySelector('.delete-month');
                    if (!deleteBtn) {
                        deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-sm btn-outline-danger delete-month';
                        deleteBtn.style.position = 'absolute';
                        deleteBtn.style.top = '5px';
                        deleteBtn.style.left = '5px';
                        deleteBtn.style.padding = '2px 6px';
                        deleteBtn.style.fontSize = '0.7rem';
                        deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            deleteMonthData(monthKey, monthCard);
                        });
                        monthCard.appendChild(deleteBtn);
                    }
                    
                    // حساب وقت المعالجة
                    const endTime = Date.now();
                    const processingTime = ((endTime - startTime) / 1000).toFixed(2);
                    
                    // إضافة إلى قائمة الملفات المرفوعة
                    addToUploadedFilesList(
                        file.name, 
                        `أطباء - ${getMonthName(month)} ${year}`, 
                        file.size, 
                        new Date().toLocaleDateString('ar-EG'), 
                        'مُعالج', 
                        doctorsMonthlyData[monthKey].data[0]?.fileId
                    );
                    
                    // تحديث الأطباء الكلية
                    updateAllDoctorsData();
                    
                    // تحديث فهارس البحث
                    buildDoctorSearchIndexes();
                    
                    console.log(`تم معالجة ملف ${getMonthName(month)} ${year} بنجاح: ${newDoctorsData.length} سجل، وقت المعالجة: ${processingTime} ثانية`);
                    
                } catch (error) {
                    console.error('خطأ في معالجة ملف الأطباء:', error);
                    monthCard.classList.remove('uploading');
                    monthCard.querySelector('i').className = 'fas fa-exclamation-circle';
                    monthCard.querySelector('.file-info').textContent = 'خطأ في المعالجة';
                    monthCard.querySelector('.file-info').style.color = 'var(--accent-color)';
                    
                    if (error.message.includes('نقص المساحة التخزينية')) {
                        alert('خطأ: تجاوزت المساحة التخزينية المتاحة. يرجى حذف بعض البيانات القديمة أو استخدام ملفات أصغر.');
                    } else {
                        alert(`حدث خطأ في معالجة الملف: ${error.message}. يرجى التحقق من صحة البيانات وتنسيق الملف.`);
                    }
                }
            };
            
            reader.onerror = function() {
                console.error('خطأ في قراءة الملف');
                monthCard.classList.remove('uploading');
                monthCard.querySelector('i').className = 'fas fa-exclamation-circle';
                monthCard.querySelector('.file-info').textContent = 'خطأ في القراءة';
                monthCard.querySelector('.file-info').style.color = 'var(--accent-color)';
                alert('حدث خطأ في قراءة الملف.');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // تحديث جميع بيانات الأطباء من بيانات الشهور
        function updateAllDoctorsData() {
            doctorsData = [];
            
            // جمع البيانات من جميع الشهور
            for (const monthKey in doctorsMonthlyData) {
                if (doctorsMonthlyData[monthKey] && doctorsMonthlyData[monthKey].data) {
                    doctorsData = doctorsData.concat(doctorsMonthlyData[monthKey].data);
                }
            }
            
            console.log(`تم تحديث بيانات جميع الأطباء: ${doctorsData.length} سجل`);
        }
        
        // الحصول على اسم الشهر من رقمه
        function getMonthName(monthNumber) {
            const monthNames = [
                'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
            ];
            return monthNames[monthNumber - 1] || '';
        }
        
        // معالجة جميع بيانات الأطباء (محسّنة)
        function processAllDoctorsData() {
            const year = document.getElementById('doctors-year').value;
            let totalRecords = 0;
            let processedMonths = 0;
            const totalMonths = 12;
            
            // التحقق من وجود بيانات
            let hasData = false;
            for (let month = 1; month <= 12; month++) {
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                if (doctorsMonthlyData[monthKey] && doctorsMonthlyData[monthKey].data) {
                    hasData = true;
                    break;
                }
            }
            
            if (!hasData) {
                alert('لم يتم رفع أي بيانات أطباء بعد. يرجى رفع ملفات الأطباء أولاً.');
                return;
            }
            
            // التحقق من سعة التخزين قبل البدء
            if (!storageManager.checkStorageSpace()) {
                alert('لا توجد مساحة تخزينية كافية. يرجى حذف بعض البيانات القديمة أولاً.');
                return;
            }
            
            // عرض مؤشر المعالجة
            const processingIndicator = document.getElementById('doctors-processing');
            const progressBar = processingIndicator.querySelector('.progress-bar');
            const processedDoctorsSpan = document.getElementById('processed-doctors');
            const doctorsSpeedSpan = document.getElementById('doctors-speed');
            
            processingIndicator.classList.add('active');
            progressBar.style.width = '0%';
            
            // تجميع بيانات جميع الشهور مع تجنب التكرار
            doctorsData = [];
            const seenDoctors = new Map();
            
            const startTime = Date.now();
            let lastUpdateTime = startTime;
            
            function processMonth(month) {
                if (month > totalMonths) {
                    // انتهاء المعالجة
                    finishProcessing();
                    return;
                }
                
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                const monthData = doctorsMonthlyData[monthKey];
                
                if (monthData && monthData.data) {
                    // إضافة البيانات مع تجنب التكرار
                    for (let i = 0; i < monthData.data.length; i++) {
                        const doctor = monthData.data[i];
                        const doctorKey = `${doctor.doctorId}_${doctor.month}_${doctor.year}`;
                        if (!seenDoctors.has(doctorKey)) {
                            seenDoctors.set(doctorKey, true);
                            doctorsData.push(doctor);
                        }
                    }
                    
                    totalRecords += monthData.data.length;
                    processedMonths++;
                    
                    // تحديث التقدم
                    const currentTime = Date.now();
                    const progressPercent = Math.round((processedMonths / totalMonths) * 100);
                    progressBar.style.width = progressPercent + '%';
                    
                    // تحديث الإحصائيات
                    processedDoctorsSpan.textContent = `${doctorsData.length} سجل`;
                    
                    if (currentTime - lastUpdateTime > 500) {
                        const timeDiff = (currentTime - startTime) / 1000;
                        const speed = Math.round(doctorsData.length / timeDiff);
                        doctorsSpeedSpan.textContent = `${speed} سجل/ثانية`;
                        lastUpdateTime = currentTime;
                    }
                }
                
                // معالجة الشهر التالي
                setTimeout(() => processMonth(month + 1), 10);
            }
            
            function finishProcessing() {
                if (doctorsData.length === 0) {
                    alert('لم يتم تحميل أي بيانات أطباء بعد. يرجى رفع ملفات الأطباء أولاً.');
                    processingIndicator.classList.remove('active');
                    return;
                }
                
                // بناء فهارس البحث
                buildDoctorSearchIndexes();
                
                // إخفاء مؤشر المعالجة
                setTimeout(() => {
                    processingIndicator.classList.remove('active');
                    progressBar.style.width = '0%';
                    
                    alert(`تم معالجة بيانات الأطباء بنجاح! تم دمج بيانات ${processedMonths} شهر بإجمالي ${doctorsData.length} سجل.`);
                }, 500);
            }
            
            // بدء المعالجة
            processMonth(1);
        }
        
        // إنشاء معرف فريد للملف
        function generateFileId() {
            return 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // إضافة ملف إلى قائمة الملفات المرفوعة
        function addToUploadedFilesList(name, type, size, date, status, fileId) {
            const fileInfo = {
                id: fileId,
                name: name,
                type: type,
                size: size,
                date: date,
                status: status
            };
            
            uploadedFiles.push(fileInfo);
            saveUploadedFiles();
            updateUploadedFilesList();
        }
        
        // تحديث قائمة الملفات المرفوعة
        function updateUploadedFilesList() {
            const tbody = document.getElementById('uploaded-files-list');
            tbody.innerHTML = '';
            
            if (uploadedFiles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-file-upload fa-2x mb-3"></i>
                            <p>لم يتم رفع أي ملفات بعد.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // عرض أحدث 10 ملفات فقط
            const recentFiles = uploadedFiles.slice(-10).reverse();
            
            for (let i = 0; i < recentFiles.length; i++) {
                const file = recentFiles[i];
                const row = document.createElement('tr');
                
                // تنسيق حجم الملف
                const sizeFormatted = formatFileSize(file.size);
                
                row.innerHTML = `
                    <td>${file.name}</td>
                    <td>${file.type}</td>
                    <td>${sizeFormatted}</td>
                    <td>${file.date}</td>
                    <td><span class="badge bg-success">${file.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewFile('${file.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }
        
        // عرض تفاصيل الملف
        function viewFile(fileId) {
            const file = uploadedFiles.find(f => f.id === fileId);
            if (!file) return;
            
            let fileDetails = `
                <h5>${file.name}</h5>
                <p><strong>النوع:</strong> ${file.type}</p>
                <p><strong>الحجم:</strong> ${formatFileSize(file.size)}</p>
                <p><strong>تاريخ الرفع:</strong> ${file.date}</p>
                <p><strong>الحالة:</strong> ${file.status}</p>
            `;
            
            alert(fileDetails);
        }
        
        // حذف الملف
        function deleteFile(fileId) {
            if (!confirm('هل أنت متأكد من أنك تريد حذف هذا الملف؟')) {
                return;
            }
            
            // تحديد نوع الملف
            const file = uploadedFiles.find(f => f.id === fileId);
            if (!file) return;
            
            if (file.type.startsWith('أطباء')) {
                // البحث عن شهر الملف وحذفه
                for (const monthKey in doctorsMonthlyData) {
                    if (doctorsMonthlyData[monthKey].data && 
                        doctorsMonthlyData[monthKey].data[0]?.fileId === fileId) {
                        delete doctorsMonthlyData[monthKey];
                        fastAddressIndexByMonth.delete(monthKey);
                        storageManager.saveData('doctorsMonthlyData', doctorsMonthlyData);
                        break;
                    }
                }
                
                // حذف بيانات الأطباء المرتبطة بهذا الملف
                doctorsData = doctorsData.filter(d => d.fileId !== fileId);
                
                // تحديث شبكة الشهور
                createMonthGrid();
                
                // تحديث فهارس البحث
                buildDoctorSearchIndexes();
            }
            
            // حذف الملف من القائمة
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            saveUploadedFiles();
            updateUploadedFilesList();
            
            alert('تم حذف الملف بنجاح');
        }
        
        // حفظ قائمة الملفات المرفوعة
        function saveUploadedFiles() {
            localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
        }
        
        // تحميل قائمة الملفات المرفوعة
        function loadUploadedFiles() {
            const storedFiles = localStorage.getItem('uploadedFiles');
            if (storedFiles) {
                uploadedFiles = JSON.parse(storedFiles);
                updateUploadedFilesList();
            }
        }
        
        // تحميل البيانات المخزنة محلياً
        function loadStoredData() {
            try {
                // تحميل بيانات الأطباء الشهرية
                const loadedMonthlyDoctors = storageManager.loadData('doctorsMonthlyData');
                if (loadedMonthlyDoctors) {
                    doctorsMonthlyData = loadedMonthlyDoctors;
                    
                    // بناء فهارس جميع الشهور المخزنة وبناء doctorsData
                    doctorsData = [];
                    for (const monthKey in doctorsMonthlyData) {
                        if (doctorsMonthlyData[monthKey]?.data) {
                            buildFastAddressIndexForMonth(monthKey);
                            doctorsData = doctorsData.concat(doctorsMonthlyData[monthKey].data);
                        }
                    }
                    
                    // بناء فهارس البحث للأطباء
                    buildDoctorSearchIndexes();
                }
                
                // تنظيف البيانات القديمة
                storageManager.cleanupOldData();
                
            } catch (e) {
                console.error('خطأ في تحميل البيانات:', e);
                doctorsData = [];
                doctorsMonthlyData = {};
            }
            
            // إنشاء شبكة الشهور بعد تحميل البيانات
            setTimeout(() => {
                createMonthGrid();
            }, 100);
        }
        
        // تحميل إعدادات مستويات التفاعل
        function loadInteractionLevels() {
            const storedLevels = localStorage.getItem('interactionLevels');
            if (storedLevels) {
                try {
                    const levels = JSON.parse(storedLevels);
                    document.getElementById('low-min').value = levels.lowMin || 0;
                    document.getElementById('low-max').value = levels.lowMax || 20;
                    document.getElementById('medium-min').value = levels.mediumMin || 21;
                    document.getElementById('medium-max').value = levels.mediumMax || 50;
                    document.getElementById('high-min').value = levels.highMin || 51;
                    document.getElementById('high-max').value = levels.highMax || 1000;
                } catch (e) {
                    console.error('خطأ في تحميل إعدادات مستويات التفاعل:', e);
                }
            }
        }
        
        // حفظ إعدادات مستويات التفاعل
        function saveInteractionLevels() {
            const levels = {
                lowMin: parseInt(document.getElementById('low-min').value) || 0,
                lowMax: parseInt(document.getElementById('low-max').value) || 20,
                mediumMin: parseInt(document.getElementById('medium-min').value) || 21,
                mediumMax: parseInt(document.getElementById('medium-max').value) || 50,
                highMin: parseInt(document.getElementById('high-min').value) || 51,
                highMax: parseInt(document.getElementById('high-max').value) || 1000
            };
            
            localStorage.setItem('interactionLevels', JSON.stringify(levels));
            alert('تم حفظ إعدادات مستويات التفاعل بنجاح');
        }
        
        // عرض قسم معين وإخفاء الآخرين
        function showSection(sectionId) {
            // إخفاء جميع الأقسام
            const sections = document.querySelectorAll('.content-section');
            for (let i = 0; i < sections.length; i++) {
                sections[i].style.display = 'none';
            }
            
            // إزالة النشاط من جميع عناصر القائمة الجانبية
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            for (let i = 0; i < navLinks.length; i++) {
                navLinks[i].classList.remove('active');
            }
            
            // عرض القسم المطلوب
            document.getElementById(sectionId).style.display = 'block';
            
            // إضافة النشاط إلى عنصر القائمة الجانبية المقابل
            const activeNavLink = document.querySelector(`.sidebar .nav-link[onclick="showSection('${sectionId}')"]`);
            if (activeNavLink) {
                activeNavLink.classList.add('active');
            }
        }
        
        // تنسيق حجم الملف
        function formatFileSize(bytes) {
            if (bytes === 0 || !bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // إنشاء تقرير البحث بالعنوان - محسّن وسريع
        function generateAddressReport() {
            if (addressSelectedDoctors.length === 0) {
                alert('لم يتم اختيار أي أطباء. يرجى البحث عن الأطباء حسب العنوان واختيارهم أولاً.');
                return;
            }
            
            if (doctorsData.length === 0) {
                alert('لم يتم تحميل بيانات الأطباء بعد. يرجى رفع ومعالجة ملفات الأطباء أولاً.');
                return;
            }
            
            // تجميع الأطباء حسب العنوان مع تجنب التكرار
            const groupedByAddress = {};
            const seenDoctors = new Set();
            
            for (let i = 0; i < addressSelectedDoctors.length; i++) {
                const doctor = addressSelectedDoctors[i];
                if (seenDoctors.has(doctor.doctorId)) {
                    continue; // تخطي الطبيب المكرر
                }
                seenDoctors.add(doctor.doctorId);
                
                const address = doctor.address;
                if (!groupedByAddress[address]) {
                    groupedByAddress[address] = [];
                }
                groupedByAddress[address].push(doctor);
            }
            
            let reportHTML = '';
            const allDoctorIds = Array.from(seenDoctors);
            
            // عنوان التقرير
            const dateFrom = document.getElementById('report-date-from').value;
            const dateTo = document.getElementById('report-date-to').value;
            
            reportHTML += `
                <div class="report-header text-center mb-4">
                    <h2>تقرير الأطباء حسب العنوان</h2>
                    <h3>جميع الأطباء المختارين من نتائج البحث</h3>
                    <p>عدد الأطباء: ${allDoctorIds.length} طبيب | عدد العناوين: ${Object.keys(groupedByAddress).length}</p>
                    <p>الفترة: ${dateFrom || 'البداية'} - ${dateTo || 'النهاية'}</p>
                </div>
            `;
            
            // إحصائيات عامة لجميع الأطباء
            const totalDoctors = allDoctorIds.length;
            const totalCases = calculateTotalCasesForDoctors(allDoctorIds);
            const totalAddresses = Object.keys(groupedByAddress).length;
            
            reportHTML += `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="address-stat-card">
                            <div class="number">${totalDoctors}</div>
                            <div class="label">عدد الأطباء</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="address-stat-card" style="background: var(--gradient-accent);">
                            <div class="number">${totalCases}</div>
                            <div class="label">إجمالي الحالات</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="address-stat-card" style="background: var(--gradient-secondary);">
                            <div class="number">${totalAddresses}</div>
                            <div class="label">عدد العناوين</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="address-stat-card" style="background: var(--gradient-success);">
                            <div class="number">${Math.round(totalCases / totalDoctors) || 0}</div>
                            <div class="label">متوسط الحالات لكل طبيب</div>
                        </div>
                    </div>
                </div>
            `;
            
            // جدول تفاصيل جميع الأطباء في كشف واحد
            reportHTML += `
                <h4 class="mb-3">تفاصيل جميع الأطباء المختارين</h4>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped address-report-table">
                        <thead>
                            <tr>
                                <th rowspan="2">اسم الطبيب</th>
                                <th rowspan="2">التخصص</th>
                                <th rowspan="2">المندوب</th>
                                <th rowspan="2">العنوان</th>
                                <th rowspan="2">إجمالي الحالات</th>
                                <th colspan="12">عدد الحالات لكل شهر</th>
                                <th rowspan="2">الهاتف</th>
                                <th rowspan="2">المنطقة</th>
                            </tr>
                            <tr>
            `;
            
            // رؤوس الأعمدة للأشهر
            const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                              'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            
            for (let i = 0; i < monthNames.length; i++) {
                reportHTML += `<th class="month-cell">${monthNames[i]}</th>`;
            }
            
            reportHTML += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // بيانات كل طبيب
            const addressKeys = Object.keys(groupedByAddress);
            for (let a = 0; a < addressKeys.length; a++) {
                const address = addressKeys[a];
                const doctorsInAddress = groupedByAddress[address];
                
                for (let d = 0; d < doctorsInAddress.length; d++) {
                    const doctor = doctorsInAddress[d];
                    const doctorId = doctor.doctorId;
                    
                    // الحصول على بيانات الطبيب الكاملة
                    const doctorFullData = doctorsData.find(d => d.doctorId == doctorId);
                    
                    // حساب إجمالي الحالات للطبيب
                    const totalDoctorCases = calculateTotalCasesForDoctor(doctorId);
                    
                    // الحصول على توزيع الحالات على الشهور
                    const monthlyCases = getMonthlyCasesForDoctor(doctorId);
                    
                    reportHTML += `
                        <tr>
                            <td><strong>${doctor.doctorName || 'غير معروف'}</strong></td>
                            <td><strong>${doctor.specialty || 'غير محدد'}</strong></td>
                            <td><strong>${doctor.rep || 'غير محدد'}</strong></td>
                            <td><strong>${address}</strong></td>
                            <td class="number-bold"><strong>${totalDoctorCases}</strong></td>
                    `;
                    
                    // بيانات الحالات لكل شهر
                    for (let m = 1; m <= 12; m++) {
                        const cases = monthlyCases[m] || 0;
                        reportHTML += `<td class="number-bold"><strong>${cases}</strong></td>`;
                    }
                    
                    reportHTML += `
                            <td><strong>${doctor.phone || 'غير محدد'}</strong></td>
                            <td><strong>${doctor.area || 'غير محدد'}</strong></td>
                        </tr>
                    `;
                }
            }
            
            reportHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // ملخص شامل لجميع الأطباء المختارين
            reportHTML += `
                <div class="report-header text-center mb-4 mt-5">
                    <h2>ملخص شامل لجميع الأطباء المختارين</h2>
                    <p>عدد الأطباء: ${allDoctorIds.length} طبيب</p>
                </div>
            `;
            
            // إحصائيات عامة
            const totalAllCases = calculateTotalCasesForDoctors(allDoctorIds);
            const avgCasesPerDoctor = allDoctorIds.length > 0 ? Math.round(totalAllCases / allDoctorIds.length) : 0;
            
            reportHTML += `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="address-stat-card">
                            <div class="number">${allDoctorIds.length}</div>
                            <div class="label">إجمالي الأطباء</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="address-stat-card" style="background: var(--gradient-accent);">
                            <div class="number">${totalAllCases}</div>
                            <div class="label">إجمالي الحالات</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="address-stat-card" style="background: var(--gradient-secondary);">
                            <div class="number">${totalAddresses}</div>
                            <div class="label">عدد العناوين</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="address-stat-card" style="background: var(--gradient-success);">
                            <div class="number">${avgCasesPerDoctor}</div>
                            <div class="label">متوسط الحالات لكل طبيب</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="address-stat-card" style="background: linear-gradient(135deg, #F39C12, #D35400);">
                            <div class="number">${Math.round(totalAllCases / 12)}</div>
                            <div class="label">متوسط الحالات شهرياً</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="address-stat-card" style="background: linear-gradient(135deg, #9B59B6, #8E44AD);">
                            <div class="number">${totalAllCases > 0 ? Math.round((totalAddresses / allDoctorIds.length) * 100) : 0}%</div>
                            <div class="label">نسبة الأطباء إلى العناوين</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="address-stat-card" style="background: linear-gradient(135deg, #1ABC9C, #16A085);">
                            <div class="number">${totalAllCases > 0 ? Math.round((totalAllCases / totalAddresses) * 100) / 100 : 0}</div>
                            <div class="label">متوسط الحالات لكل عنوان</div>
                        </div>
                    </div>
                </div>
            `;
            
            // إضافة توقيع التقرير
            reportHTML += `
                <div class="mt-5">
                    <div class="signature">أخصائي العلاقات<br>سام جميل القدسي</div>
                </div>
            `;
            
            // حفظ البيانات للتقرير الحالي
            currentReportData = addressSelectedDoctors;
            
            // عرض التقرير
            document.getElementById('report-preview').innerHTML = reportHTML;
            
            // رسم الرسوم البيانية بعد عرض التقرير
            setTimeout(() => {
                drawAddressReportCharts();
            }, 100);
        }
        
        // حساب إجمالي الحالات لطبيب معين
        function calculateTotalCasesForDoctor(doctorId) {
            let totalCases = 0;
            
            // جمع الحالات من جميع ملفات الأطباء
            for (let i = 0; i < doctorsData.length; i++) {
                const doctor = doctorsData[i];
                if (doctor.doctorId == doctorId) {
                    totalCases += parseInt(doctor.cases) || 0;
                }
            }
            
            return totalCases;
        }
        
        // حساب إجمالي الحالات لمجموعة أطباء
        function calculateTotalCasesForDoctors(doctorIds) {
            let totalCases = 0;
            
            for (let i = 0; i < doctorIds.length; i++) {
                totalCases += calculateTotalCasesForDoctor(doctorIds[i]);
            }
            
            return totalCases;
        }
        
        // الحصول على توزيع الحالات على الشهور لطبيب
        function getMonthlyCasesForDoctor(doctorId) {
            const monthlyCases = {};
            
            // تهيئة جميع الشهور بصفر
            for (let i = 1; i <= 12; i++) {
                monthlyCases[i] = 0;
            }
            
            // جمع الحالات من جميع ملفات الأطباء
            for (let i = 0; i < doctorsData.length; i++) {
                const doctor = doctorsData[i];
                if (doctor.doctorId == doctorId) {
                    const month = parseInt(doctor.month);
                    if (month >= 1 && month <= 12) {
                        monthlyCases[month] += parseInt(doctor.cases) || 0;
                    }
                }
            }
            
            return monthlyCases;
        }
        
        // الحصول على ملخص التخصصات لمجموعة أطباء
        function getSpecialtySummaryForDoctors(doctorIds) {
            const specialtySummary = {};
            
            for (let i = 0; i < doctorIds.length; i++) {
                const doctorId = doctorIds[i];
                // البحث عن تخصص الطبيب من بيانات الأطباء
                const doctor = doctorsData.find(d => d.doctorId == doctorId);
                const specialty = doctor ? (doctor.specialty || 'غير محدد') : 'غير محدد';
                
                // استبعاد "غير محدد"
                if (specialty === 'غير محدد' || !specialty || specialty.trim() === '') {
                    continue;
                }
                
                if (!specialtySummary[specialty]) {
                    specialtySummary[specialty] = {
                        doctors: 0,
                        cases: 0
                    };
                }
                
                specialtySummary[specialty].doctors++;
                specialtySummary[specialty].cases += calculateTotalCasesForDoctor(doctorId);
            }
            
            return specialtySummary;
        }
        
        // الحصول على توزيع الحالات على الشهور لجميع الأطباء المختارين
        function getMonthlyCasesForSelectedDoctors() {
            const monthlyCases = {};
            
            // تهيئة جميع الشهور بصفر
            for (let i = 1; i <= 12; i++) {
                monthlyCases[i] = 0;
            }
            
            // جمع الحالات من جميع الأطباء المختارين
            for (let i = 0; i < addressSelectedDoctors.length; i++) {
                const doctor = addressSelectedDoctors[i];
                const doctorMonthlyCases = getMonthlyCasesForDoctor(doctor.doctorId);
                
                for (let month = 1; month <= 12; month++) {
                    monthlyCases[month] += doctorMonthlyCases[month] || 0;
                }
            }
            
            return monthlyCases;
        }
        
        // الحصول على توزيع عدد الأطباء على المندوبين لجميع الأطباء المختارين
        function getRepDoctorsCountForSelectedDoctors() {
            const repDoctors = {};
            
            // تجميع الأطباء حسب المندوب مع تجنب التكرار
            const repDoctorMap = new Map();
            
            for (let i = 0; i < addressSelectedDoctors.length; i++) {
                const doctor = addressSelectedDoctors[i];
                const rep = doctor.rep || 'غير محدد';
                const doctorId = doctor.doctorId;
                
                // استبعاد "غير محدد"
                if (rep === 'غير محدد' || !rep || rep.trim() === '') {
                    continue;
                }
                
                if (!repDoctorMap.has(rep)) {
                    repDoctorMap.set(rep, new Set());
                }
                repDoctorMap.get(rep).add(doctorId);
            }
            
            // تحويل الماب إلى كائن
            const repDoctorCounts = {};
            repDoctorMap.forEach((doctorSet, rep) => {
                repDoctorCounts[rep] = doctorSet.size;
            });
            
            return repDoctorCounts;
        }
        
        // تحويل الرسوم البيانية إلى صور عالية الدقة للطباعة
        async function convertChartsToHighResImages() {
            chartImagesForPrint = {};
            
            // قائمة الرسوم البيانية
            const chartIds = ['report-chart-1', 'report-chart-2', 'report-chart-3', 'report-chart-4'];
            
            for (const chartId of chartIds) {
                const canvas = document.getElementById(chartId);
                if (!canvas) continue;
                
                try {
                    // إنشاء نسخة من الكانفاس بدقة أعلى
                    const offscreenCanvas = document.createElement('canvas');
                    const ctx = offscreenCanvas.getContext('2d');
                    
                    // تحديد الأبعاد عالية الدقة
                    const scale = 3; // زيادة الدقة 3 مرات
                    offscreenCanvas.width = canvas.width * scale;
                    offscreenCanvas.height = canvas.height * scale;
                    
                    // نسخ الرسم البياني بدقة عالية
                    ctx.scale(scale, scale);
                    ctx.drawImage(canvas, 0, 0);
                    
                    // تحويل إلى صورة base64
                    const imageData = offscreenCanvas.toDataURL('image/png', 1.0);
                    chartImagesForPrint[chartId] = imageData;
                    
                    console.log(`تم تحويل الرسم البياني ${chartId} إلى صورة عالية الدقة`);
                } catch (error) {
                    console.error(`خطأ في تحويل الرسم البياني ${chartId}:`, error);
                }
            }
            
            return chartImagesForPrint;
        }
        
        // رسم الرسوم البيانية لتقرير العنوان - محسّن
        function drawAddressReportCharts() {
            // تدمير الرسوم البيانية القديمة إن وجدت
            if (reportChart1) reportChart1.destroy();
            if (reportChart2) reportChart2.destroy();
            if (reportChart3) reportChart3.destroy();
            if (reportChart4) reportChart4.destroy();
            
            if (addressSelectedDoctors.length === 0) return;
            
            // إظهار قسم الرسوم البيانية
            document.getElementById('report-charts-section').style.display = 'block';
            
            // 1. الرسم البياني: إجمالي عدد الحالات لكل شهر
            const monthlyCases = getMonthlyCasesForSelectedDoctors();
            const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                              'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            
            const monthlyCasesData = [];
            for (let i = 1; i <= 12; i++) {
                monthlyCasesData.push(monthlyCases[i] || 0);
            }
            
            // رسم بياني 1: إجمالي عدد الحالات لكل شهر
            const chart1Ctx = document.getElementById('report-chart-1').getContext('2d');
            reportChart1 = new Chart(chart1Ctx, {
                type: 'bar',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'عدد الحالات',
                        data: monthlyCasesData,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'إجمالي عدد الحالات لكل شهر',
                            font: {
                                size: 16,
                                weight: '900'
                            }
                        },
                        legend: {
                            labels: {
                                font: {
                                    weight: '900'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '900'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '900'
                                }
                            }
                        }
                    }
                }
            });
            
            // 2. الرسم البياني: عدد الأطباء لكل مندوب
            const repDoctorsCount = getRepDoctorsCountForSelectedDoctors();
            const repNames = Object.keys(repDoctorsCount);
            const repDoctorsData = Object.values(repDoctorsCount);
            
            // إذا لم تكن هناك بيانات، لا نرسم الرسم البياني
            if (repNames.length === 0) {
                document.getElementById('report-chart-2').parentElement.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>لا توجد بيانات كافية لرسم الرسم البياني</p>
                    </div>
                `;
            } else {
                // رسم بياني 2: عدد الأطباء لكل مندوب
                const chart2Ctx = document.getElementById('report-chart-2').getContext('2d');
                reportChart2 = new Chart(chart2Ctx, {
                    type: 'bar',
                    data: {
                        labels: repNames,
                        datasets: [{
                            label: 'عدد الأطباء',
                            data: repDoctorsData,
                            backgroundColor: '#2ecc71',
                            borderColor: '#27ae60',
                            borderWidth: 2,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'عدد الأطباء لكل مندوب',
                                font: {
                                    size: 16,
                                    weight: '900'
                                }
                            },
                            legend: {
                                labels: {
                                    font: {
                                        weight: '900'
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 12,
                                        weight: '900'
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 12,
                                        weight: '900'
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // 3. الرسم البياني: توزيع التخصصات بعدد الأطباء
            const allDoctorIds = addressSelectedDoctors.map(d => d.doctorId);
            const specialtySummary = getSpecialtySummaryForDoctors(allDoctorIds);
            
            const specialtyLabels = Object.keys(specialtySummary);
            const specialtyDoctors = Object.values(specialtySummary).map(s => s.doctors);
            
            // إذا لم تكن هناك بيانات، لا نرسم الرسم البياني
            if (specialtyLabels.length === 0) {
                document.getElementById('report-chart-3').parentElement.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-pie fa-3x mb-3"></i>
                        <p>لا توجد بيانات تخصصات كافية لرسم الرسم البياني</p>
                    </div>
                `;
            } else {
                // رسم بياني 3: توزيع التخصصات بعدد الأطباء
                const chart3Ctx = document.getElementById('report-chart-3').getContext('2d');
                reportChart3 = new Chart(chart3Ctx, {
                    type: 'pie',
                    data: {
                        labels: specialtyLabels,
                        datasets: [{
                            data: specialtyDoctors,
                            backgroundColor: [
                                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', 
                                '#9b59b6', '#1abc9c', '#34495e', '#d35400'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 12,
                                        weight: '900'
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'توزيع التخصصات بعدد الأطباء',
                                font: {
                                    size: 16,
                                    weight: '900'
                                }
                            }
                        }
                    }
                });
            }
            
            // 4. الرسم البياني: توزيع التخصصات بعدد الحالات
            const specialtyCases = Object.values(specialtySummary).map(s => s.cases);
            
            // إذا لم تكن هناك بيانات، لا نرسم الرسم البياني
            if (specialtyLabels.length === 0) {
                document.getElementById('report-chart-4').parentElement.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>لا توجد بيانات تخصصات كافية لرسم الرسم البياني</p>
                    </div>
                `;
            } else {
                // رسم بياني 4: توزيع التخصصات بعدد الحالات
                const chart4Ctx = document.getElementById('report-chart-4').getContext('2d');
                reportChart4 = new Chart(chart4Ctx, {
                    type: 'doughnut',
                    data: {
                        labels: specialtyLabels,
                        datasets: [{
                            data: specialtyCases,
                            backgroundColor: [
                                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', 
                                '#9b59b6', '#1abc9c', '#34495e', '#d35400'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 12,
                                        weight: '900'
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'توزيع التخصصات بعدد الحالات',
                                font: {
                                    size: 16,
                                    weight: '900'
                                }
                            }
                        }
                    }
                });
            }
            
            // تحويل الرسوم البيانية إلى صور عالية الدقة للطباعة
            setTimeout(() => {
                convertChartsToHighResImages();
            }, 1000);
        }
        
        // طباعة التقرير مع تحسين التنسيق وإظهار الرسوم البيانية
        async function printReport() {
            // تحويل الرسوم البيانية إلى صور عالية الدقة أولاً
            await convertChartsToHighResImages();
            
            const reportContent = document.getElementById('report-preview').innerHTML;
            
            // إنشاء نافذة طباعة
            const printWindow = window.open('', '_blank');
            
            // إنشاء محتوى HTML للطباعة مع تحسين التنسيق
            let printContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>طباعة التقرير</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap');
                        
                        body {
                            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            direction: rtl;
                            padding: 10px;
                            color: #333;
                            font-size: 10px !important;
                            font-weight: 900 !important;
                            background: white;
                        }
                        
                        @page {
                            size: landscape;
                            margin: 10mm;
                        }
                        
                        .report-header {
                            background: linear-gradient(135deg, #2C3E50, #34495E) !important;
                            color: #FFFFFF !important;
                            padding: 15px !important;
                            border-radius: 12px !important;
                            text-align: center !important;
                            margin-bottom: 15px !important;
                            font-weight: 900 !important;
                            font-size: 14px !important;
                        }
                        
                        .report-header h2, .report-header h3 {
                            color: #FFFFFF !important;
                            font-weight: 900 !important;
                            margin: 5px 0 !important;
                        }
                        
                        .stat-card {
                            text-align: center;
                            padding: 15px 10px !important;
                            background: #FFFFFF !important;
                            border-radius: 8px !important;
                            border: 1px solid #E8E8E8 !important;
                            margin-bottom: 10px !important;
                        }
                        
                        .stat-card .number {
                            font-size: 1.8rem !important;
                            font-weight: 900 !important;
                            color: #2C3E50 !important;
                            line-height: 1;
                            margin: 5px 0 !important;
                        }
                        
                        .stat-card .label {
                            font-size: 1rem !important;
                            color: #7F8C8D !important;
                            font-weight: 900 !important;
                        }
                        
                        .signature {
                            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
                            font-size: 1rem !important;
                            color: #2C3E50 !important;
                            margin-top: 20px !important;
                            padding-top: 10px !important;
                            display: inline-block;
                            font-weight: 900 !important;
                            text-align: left !important;
                            float: left !important;
                            border-top: 3px solid #E74C3C !important;
                            padding-right: 15px !important;
                        }
                        
                        .table {
                            border-radius: 8px !important;
                            overflow: hidden !important;
                            border: 1px solid #E8E8E8 !important;
                            margin-bottom: 15px !important;
                            font-size: 9px !important;
                            width: 100% !important;
                            table-layout: fixed !important;
                            font-weight: 900 !important;
                        }
                        
                        .table thead th {
                            background: linear-gradient(135deg, #2C3E50, #34495E) !important;
                            color: white !important;
                            font-weight: 900 !important;
                            font-size: 10px !important;
                            border: none !important;
                            padding: 8px 10px !important;
                            vertical-align: middle !important;
                        }
                        
                        .table tbody td {
                            padding: 6px 8px !important;
                            font-weight: 900 !important;
                            vertical-align: middle !important;
                            border-color: #ECF0F1 !important;
                            word-wrap: break-word !important;
                            white-space: normal !important;
                        }
                        
                        .table-striped tbody tr:nth-of-type(odd) {
                            background-color: rgba(236, 240, 241, 0.3) !important;
                        }
                        
                        .address-stat-card {
                            background: linear-gradient(135deg, #1ABC9C, #16A085) !important;
                            color: white !important;
                            border-radius: 8px !important;
                            padding: 15px 10px !important;
                            margin-bottom: 10px !important;
                            text-align: center !important;
                        }
                        
                        .address-stat-card .number {
                            font-size: 1.8rem !important;
                            font-weight: 900 !important;
                        }
                        
                        .address-stat-card .label {
                            font-size: 1rem !important;
                            opacity: 0.95 !important;
                            font-weight: 900 !important;
                        }
                        
                        .address-report-table {
                            font-size: 8px !important;
                        }
                        
                        .address-report-table th,
                        .address-report-table td {
                            padding: 4px 6px !important;
                            border: 1px solid #ddd !important;
                            font-weight: 900 !important;
                        }
                        
                        .address-report-table .month-cell {
                            min-width: 30px !important;
                            font-size: 7px !important;
                            font-weight: 900 !important;
                        }
                        
                        .area-classification {
                            display: inline-block !important;
                            padding: 4px 8px !important;
                            border-radius: 4px !important;
                            font-size: 8px !important;
                            font-weight: 900 !important;
                            margin-right: 3px !important;
                            color: white !important;
                        }
                        
                        .area-a {
                            background: linear-gradient(135deg, #E74C3C, #C0392B) !important;
                        }
                        
                        .area-b {
                            background: linear-gradient(135deg, #F39C12, #D35400) !important;
                        }
                        
                        .area-c {
                            background: linear-gradient(135deg, #27AE60, #229954) !important;
                        }
                        
                        .card {
                            border: 1px solid #ddd !important;
                            box-shadow: none !important;
                            margin-bottom: 10px !important;
                            page-break-inside: avoid !important;
                        }
                        
                        .card-header {
                            padding: 8px 10px !important;
                            font-size: 1em !important;
                            font-weight: 900 !important;
                        }
                        
                        .card-body {
                            padding: 10px !important;
                        }
                        
                        .row {
                            margin: 0 !important;
                        }
                        
                        .col-md-1, .col-md-2, .col-md-3, .col-md-4, 
                        .col-md-5, .col-md-6, .col-md-7, .col-md-8, 
                        .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
                            padding: 5px !important;
                        }
                        
                        h1, h2, h3, h4 {
                            margin: 5px 0 !important;
                            font-size: 1.2em !important;
                            font-weight: 900 !important;
                        }
                        
                        /* إصلاح عرض الجداول في الطباعة */
                        table {
                            width: 100% !important;
                            table-layout: fixed !important;
                        }
                        th, td {
                            max-width: none !important;
                            min-width: 40px !important;
                            font-weight: 900 !important;
                        }
                        /* منع تكسير النصوص الطويلة */
                        td, th {
                            word-break: break-word !important;
                            overflow-wrap: break-word !important;
                            font-weight: 900 !important;
                        }
                        /* الرسوم البيانية كصور */
                        .print-chart-img {
                            max-width: 100% !important;
                            height: auto !important;
                            page-break-inside: avoid !important;
                            margin-bottom: 15px !important;
                            border: 1px solid #ddd !important;
                            border-radius: 8px !important;
                            padding: 10px !important;
                        }
                        .chart-title {
                            text-align: center !important;
                            font-weight: 900 !important;
                            margin-bottom: 5px !important;
                            font-size: 11px !important;
                        }
                        /* زيادة دقة الصور */
                        img {
                            max-width: 100% !important;
                            height: auto !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        .number-bold {
                            font-weight: 900 !important;
                            font-size: 1.1em !important;
                        }
                    </style>
                </head>
                <body>
                    <div class="container-fluid">
                        ${reportContent}
                        
                        <!-- إضافة الرسوم البيانية كصور -->
                        <div class="row mt-4">
            `;
            
            // إضافة صور الرسوم البيانية إذا كانت متوفرة
            const chartTitles = [
                'إجمالي عدد الحالات لكل شهر',
                'عدد الأطباء لكل مندوب',
                'توزيع التخصصات بعدد الأطباء',
                'توزيع التخصصات بعدد الحالات'
            ];
            
            for (let i = 0; i < 4; i++) {
                const chartId = `report-chart-${i + 1}`;
                if (chartImagesForPrint[chartId]) {
                    printContent += `
                        <div class="col-md-6 mb-4">
                            <div class="chart-title">${chartTitles[i]}</div>
                            <img src="${chartImagesForPrint[chartId]}" class="print-chart-img" alt="${chartTitles[i]}">
                        </div>
                    `;
                }
            }
            
            printContent += `
                        </div>
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        };
                    <\/script>
                </body>
                </html>
            `;
            
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
        }
        
        // تصدير التقرير إلى Excel
        function exportToExcel() {
            if (currentReportData.length === 0) {
                alert('لا توجد بيانات لتصديرها. يرجى إنشاء تقرير أولاً.');
                return;
            }
            
            // إنشاء مصنف Excel
            const wb = XLSX.utils.book_new();
            
            // تحويل البيانات إلى ورقة عمل
            const exportData = currentReportData.map(doctor => {
                const totalCases = calculateTotalCasesForDoctor(doctor.doctorId);
                const monthlyCases = getMonthlyCasesForDoctor(doctor.doctorId);
                
                const rowData = {
                    'اسم الطبيب': doctor.doctorName,
                    'رقم الطبيب': doctor.doctorId,
                    'التخصص': doctor.specialty,
                    'المندوب': doctor.rep,
                    'العنوان': doctor.address,
                    'المنطقة': doctor.area,
                    'الهاتف': doctor.phone,
                    'إجمالي الحالات': totalCases
                };
                
                // إضافة بيانات الحالات لكل شهر
                const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                                  'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                
                for (let i = 0; i < monthNames.length; i++) {
                    rowData[monthNames[i]] = monthlyCases[i + 1] || 0;
                }
                
                return rowData;
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // إضافة الورقة إلى المصنف
            XLSX.utils.book_append_sheet(wb, ws, 'تقرير الأطباء حسب العنوان');
            
            // حفظ الملف
            const fileName = `تقرير_الأطباء_حسب_العنوان_${new Date().toLocaleDateString('ar-EG').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // إعادة تعيين البيانات
        function resetData() {
            if (confirm('هل أنت متأكد من إعادة تعيين جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                localStorage.clear();
                doctorsData = [];
                uploadedFiles = [];
                currentReportData = [];
                doctorsMonthlyData = {};
                addressSearchResults = [];
                addressSelectedDoctors = [];
                allSearchDoctors = [];
                filteredSearchDoctors = [];
                fastAddressIndexByMonth.clear();
                addressSearchCache = {};
                chartImagesForPrint = {};
                
                // بيانات تقرير الطبيب
                currentDoctor = null;
                doctorSearchCache = {};
                doctorNameIndex.clear();
                doctorSpecialtyIndex.clear();
                doctorAutocompleteResults = [];
                if (doctorChart1) doctorChart1.destroy();
                if (doctorChart2) doctorChart2.destroy();
                
                // تحديث الواجهة
                updateUploadedFilesList();
                createMonthGrid();
                updateAddressSelectedDoctorsDisplay();
                
                // إخفاء معلومات البحث
                document.getElementById('search-perf-info').style.display = 'none';
                document.getElementById('select-all-results-btn').style.display = 'none';
                document.getElementById('address-filters').style.display = 'none';
                document.getElementById('address-search-results').style.display = 'none';
                document.getElementById('address-search-stats').style.display = 'none';
                document.getElementById('report-charts-section').style.display = 'none';
                
                // إخفاء أقسام تقرير الطبيب
                document.getElementById('doctor-stats-section').style.display = 'none';
                document.getElementById('doctor-details-section').style.display = 'none';
                document.getElementById('doctor-charts-section').style.display = 'none';
                document.getElementById('search-doctor-stats').style.display = 'none';
                
                // إعادة تعيين نموذج التقرير
                document.getElementById('address-search').value = '';
                document.getElementById('report-date-from').value = '';
                document.getElementById('report-date-to').value = '';
                document.getElementById('doctor-search-input').value = '';
                
                // إعادة تعيين إعدادات مستويات التفاعل
                document.getElementById('low-min').value = 0;
                document.getElementById('low-max').value = 20;
                document.getElementById('medium-min').value = 21;
                document.getElementById('medium-max').value = 50;
                document.getElementById('high-min').value = 51;
                document.getElementById('high-max').value = 1000;
                
                alert('تم إعادة تعيين جميع البيانات بنجاح');
            }
        }
        
        // نسخ احتياطي للبيانات
        function backupData() {
            const backupData = {
                doctorsData: doctorsData,
                uploadedFiles: uploadedFiles,
                doctorsMonthlyData: doctorsMonthlyData,
                addressSelectedDoctors: addressSelectedDoctors,
                interactionLevels: {
                    lowMin: parseInt(document.getElementById('low-min').value) || 0,
                    lowMax: parseInt(document.getElementById('low-max').value) || 20,
                    mediumMin: parseInt(document.getElementById('medium-min').value) || 21,
                    mediumMax: parseInt(document.getElementById('medium-max').value) || 50,
                    highMin: parseInt(document.getElementById('high-min').value) || 51,
                    highMax: parseInt(document.getElementById('high-max').value) || 1000
                },
                backupDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `نسخة_احتياطية_${new Date().toLocaleDateString('ar-EG').replace(/\//g, '-')}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('تم إنشاء نسخة احتياطية من البيانات بنجاح');
        }
        
        // استعادة البيانات
        function restoreData() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // استعادة البيانات
                        doctorsData = backupData.doctorsData || [];
                        uploadedFiles = backupData.uploadedFiles || [];
                        doctorsMonthlyData = backupData.doctorsMonthlyData || {};
                        addressSelectedDoctors = backupData.addressSelectedDoctors || [];
                        
                        // استعادة إعدادات مستويات التفاعل
                        if (backupData.interactionLevels) {
                            document.getElementById('low-min').value = backupData.interactionLevels.lowMin || 0;
                            document.getElementById('low-max').value = backupData.interactionLevels.lowMax || 20;
                            document.getElementById('medium-min').value = backupData.interactionLevels.mediumMin || 21;
                            document.getElementById('medium-max').value = backupData.interactionLevels.mediumMax || 50;
                            document.getElementById('high-min').value = backupData.interactionLevels.highMin || 51;
                            document.getElementById('high-max').value = backupData.interactionLevels.highMax || 1000;
                        }
                        
                        // حفظ البيانات محلياً باستخدام مدير التخزين
                        storageManager.saveData('doctorsMonthlyData', doctorsMonthlyData);
                        localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                        
                        // بناء فهارس جميع الشهور
                        fastAddressIndexByMonth.clear();
                        for (const monthKey in doctorsMonthlyData) {
                            if (doctorsMonthlyData[monthKey]?.data) {
                                buildFastAddressIndexForMonth(monthKey);
                            }
                        }
                        
                        // بناء فهارس البحث للأطباء
                        buildDoctorSearchIndexes();
                        
                        // تحديث الواجهة
                        updateUploadedFilesList();
                        createMonthGrid();
                        updateAddressSelectedDoctorsDisplay();
                        
                        alert('تم استعادة البيانات بنجاح');
                    } catch (error) {
                        console.error('خطأ في استعادة البيانات:', error);
                        alert('خطأ في استعادة البيانات: الملف غير صالح');
                    }
                };
                
                reader.readAsText(file);
            };
            
            fileInput.click();
        }
        
        // إنشاء تقرير جديد
        function generateReport() {
            // تعيين القيم الافتراضية
            document.getElementById('address-search').value = '';
            document.getElementById('report-date-from').value = '';
            document.getElementById('report-date-to').value = '';
            
            // إخفاء نتائج البحث
            document.getElementById('address-search-results').style.display = 'none';
            document.getElementById('address-search-stats').style.display = 'none';
            document.getElementById('address-filters').style.display = 'none';
            document.getElementById('select-all-results-btn').style.display = 'none';
            document.getElementById('search-perf-info').style.display = 'none';
            document.getElementById('report-charts-section').style.display = 'none';
            
            // مسح الأطباء المحددين
            addressSelectedDoctors = [];
            updateAddressSelectedDoctorsDisplay();
            
            // إعادة تعيين معاينة التقرير
            document.getElementById('report-preview').innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-file-alt fa-3x mb-3"></i>
                    <p>لم يتم إنشاء تقرير بعد. استخدم الإعدادات على اليسار لإنشاء تقرير.</p>
                </div>
            `;
            
            // الانتقال إلى قسم التقارير
            showSection('reports-section');
        }
    </script>
</body>
</html>